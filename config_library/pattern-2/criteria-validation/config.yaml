# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: MIT-0

# All settings not explicitly defined here are inherited from system defaults.

notes: Criteria validation configuration for healthcare/insurance prior authorization - Pattern2 (Bedrock LLM)

criteria_validation:
  model: us.anthropic.claude-3-5-sonnet-20240620-v1:0
  temperature: 0.0
  top_k: 20
  top_p: 0.01
  max_tokens: 4096
  semaphore: 3  # Number of concurrent API calls
  max_chunk_size: 180000  # Maximum tokens per chunk
  token_size: 4  # Average characters per token
  overlap_percentage: 10  # Chunk overlap percentage
  response_prefix: "<response>"
  
  # Main validation prompt
  system_prompt: |
    You are a specialized insurance evaluator tasked with determining the eligibility of insurance coverage based on a patient's user history and a set of criterias. 
    Each evaluation should be supported by precise reasoning, with citations from the user history where applicable.
  
  task_prompt: |
    Consider the patients user history inforamtion provided insided <user_history></user_history> XML tags.

    <user_history>
     <source_filepath>
     {source_filepath}
     </source_filepath>

     <content>
     {content}
     </content>
    </user_history>

    <criteria>
    <criteria_type>
    {criteria_type}
    </criteria_type>

    <question>
    {question}
    </question>
    </criteria>

    <instruction>
    Evaluate the patient's insurance eligibility for each question provided insided <question></question> XML tags  and patients user history information provided inside <user_history></user_history> XML tags. 

    Your Task:

    For each question, provide:

    Decision: Carefully review each requirement in the context of the patient's user history to decide if it is "Pass," "Fail," or "Information Not Found" and select one of the following options:

    {recommendation_options}

    Reasoning: Provide a brief explanation for the decision, highlighting any relevant details or absence of data.
    Citations: When applicable, cite specific sections of the user history (e.g., page numbers, sections, S3 URI) that support your decision.

    Json Response format:
    {{
     "criteria_type" : "question/criteria type mentioned inside <criteria_type></criteria_type> XML tags"
     "source_file" : ["list of source_filepath that supports the recommendation"]
     "question" : "question Description"
     "Recommendation" : "This should be one of the following: Pass, Fail, or Information Not Found"
     "Reasoning" : "Provide a thorough explanation, reasoning, and any citations from the source_file in a Single  paragraph explanation without line breaks"
    }}
    All fields must be included in the JSON response, even if some values are unavailable (leave them as empty strings if necessary).
    Ensure that the output is a valid JSON object and strictly adheres to the format provided above.
    criteria_type must be included as a field within the JSON and not as the primary key.
    The reasoning field must include detailed explanations and citations to support the decision.

    </instruction>

    Follow instructions provided inside <instruction></instruction> XML tags. 
    Provide the output in a Json format inside <response></response> XML tags. Do not include any space after <response> tag and before </response> tag.

  # Criteria definitions nested under criteria_validation
  criteria:
    administration_requirements:
      - "Will the immunotherapy be administered under the supervision of an appropriately trained physician?"
      - "Is the facility equipped to treat anaphylaxis?"
      - "Has the physician determined an appropriate dosage regimen and progression schedule?"
      - "Are there adequate safety protocols in place for infusion reactions?"
    medical_necessity:
      - "Has the patient failed standard treatments?"
      - "Is the proposed treatment medically necessary?"
      - "Does the patient meet the clinical criteria for this treatment?"
    dosage_requirements:
      - "Is the dosage appropriate for the patient's condition?"
      - "Has the physician documented the rationale for the selected dosage?"
      - "Are dosage adjustments based on patient response documented?"
    safety_requirements:
      - "Are safety protocols adequate for the proposed treatment?"
      - "Has the patient been screened for contraindications?"
      - "Are monitoring procedures in place during treatment?"
    
    # Recommendation options under criteria
    recommendation_options: |
      Pass: The requirement criteria are fully met.
      Fail: The requirement is partially met or requires additional information.
      Information Not Found: No relevant data exists in the user history.

