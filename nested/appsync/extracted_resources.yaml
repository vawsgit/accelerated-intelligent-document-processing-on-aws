# Lambda Functions, LogGroups, DataSources, and Resolvers

  # LogGroup for abort_workflow_resolver
  AbortWorkflowResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays


  # Function: abort_workflow_resolver
  AbortWorkflowResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/abort_workflow_resolver
      Description: Lambda function to abort document workflows via GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          APPSYNC_API_URL: !GetAtt GraphQLApi.GraphQLUrl
      LoggingConfig:
        LogGroup: !Ref AbortWorkflowResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTable
        - StepFunctionsExecutionPolicy:
            StateMachineName: !If
              - IsPattern3
              - !GetAtt PATTERN3STACK.Outputs.StateMachineName
              - !If
                - IsPattern2
                - !GetAtt PATTERN2STACK.Outputs.StateMachineName
                - !GetAtt PATTERN1STACK.Outputs.StateMachineName
        - Statement:
            - Effect: Allow
              Action:
                - appsync:GraphQL
              Resource:
                - !Sub "${GraphQLApi.Arn}/types/Query/*"
                - !Sub "${GraphQLApi.Arn}/types/Mutation/*"
            - Effect: Allow
              Action:
                - states:StopExecution
              Resource:
                - !If
                  - IsPattern3
                  - !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:execution:${PATTERN3STACK.Outputs.StateMachineName}:*"
                  - !If
                    - IsPattern2
                    - !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:execution:${PATTERN2STACK.Outputs.StateMachineName}:*"
                    - !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:execution:${PATTERN1STACK.Outputs.StateMachineName}:*"
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # Function: agent_chat_resolver
  AgentChatResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W58
            reason: "DLQ not required for AppSeync Resolver function"
          - id: W11
            reason: "Role requires * resource access for Marketplace, CloudWatch Metrics and Logs"
    # checkov:skip=CKV_AWS_116: "DLQ not required for analytics processor as it's invoked asynchronously by request handler with error handling and job status tracking in DynamoDB"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      CodeUri: src/lambda/agent_chat_resolver/
      Handler: index.handler
      Runtime: python3.12
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          CHAT_MESSAGES_TABLE: !Ref ChatMessagesTable
          AGENT_CHAT_PROCESSOR_FUNCTION: !Ref AgentChatProcessorFunction
          DATA_RETENTION_DAYS: !Ref DataRetentionInDays
          CHAT_SESSIONS_TABLE: !Ref ChatSessionsTable
      LoggingConfig:
        LogGroup: !Ref AgentChatResolverLogGroup
      Policies:
        - Statement:
            Effect: Allow
            Action: lambda:InvokeFunction
            Resource: !GetAtt AgentChatProcessorFunction.Arn
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatMessagesTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatSessionsTable
        - LambdaInvokePolicy:
            FunctionName: !Ref AgentChatProcessorFunction
        - Statement:
            Effect: Allow
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # DataSource for agent_chat_resolver
  AgentChatResolverDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      Name: AgentChatResolverDataSource
      Description: Lambda function for handling agent chat messages
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt AgentChatResolverFunction.Arn


  # Function: agent_request_handler
  AgentRequestHandlerFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for analytics request handler as it's invoked synchronously via AppSync and errors are handled by the caller"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      CodeUri: src/lambda/agent_request_handler/
      Handler: index.handler
      Runtime: python3.12
      Timeout: 30
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          AGENT_TABLE: !Ref AgentTable
          AGENT_PROCESSOR_FUNCTION: !Ref AgentProcessorFunction
          DATA_RETENTION_DAYS: !Ref DataRetentionInDays
      LoggingConfig:
        LogGroup: !Ref AgentRequestHandlerLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref AgentTable
        - LambdaInvokePolicy:
            FunctionName: !Ref AgentProcessorFunction
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn

  # Lambda function for agent processor

  # DataSource for agent_request_handler
  AgentRequestHandlerDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      Name: AgentRequestHandlerDataSource
      Description: Lambda function for handling agent query requests
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt AgentRequestHandlerFunction.Arn


  # LogGroup for chat_with_document_resolver
  ChatWithDocumentResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays


  # Function: chat_with_document_resolver
  ChatWithDocumentResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
          - id: W11
            reason: "Role requires * resource access for CloudWatch Metrics and Logs"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/chat_with_document_resolver
      Description: Lambda function to chat with the document via GraphQL API
      MemorySize: 512
      Timeout: 120
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          OUTPUT_BUCKET: !Ref OutputBucket
          CONFIGURATION_TABLE_NAME: !Ref ConfigurationTable
          TRACKING_TABLE_NAME: !Ref TrackingTable
          GUARDRAIL_ID_AND_VERSION:
            !If [
              HasGuardrailConfig,
              !Sub "${BedrockGuardrailId}:${BedrockGuardrailVersion}",
              "",
            ]
      LoggingConfig:
        LogGroup: !Ref ChatWithDocumentResolverFunctionLogGroup
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref OutputBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref ConfigurationTable
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTable
        - Statement:
            - !If
              - ShouldUseDocumentKnowledgeBase
              - Effect: Allow
                Action:
                  - bedrock:Retrieve
                  - bedrock:RetrieveAndGenerate
                Resource: !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/${DOCUMENTKB.Outputs.KnowledgeBaseID}"
              - !Ref AWS::NoValue
            - Effect: Allow
              Action:
                - "bedrock:InvokeModel"
              Resource:
                - !Sub "arn:${AWS::Partition}:bedrock:*::foundation-model/*"
                - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*"
            - Effect: Allow
              Action:
                - aws-marketplace:Subscribe
                - aws-marketplace:Unsubscribe
                - aws-marketplace:ViewSubscriptions
              Resource: "*"
            - Effect: Allow
              Action:
                - cloudwatch:PutMetricData
              Resource: "*"
            - Effect: Allow
              Action:
                - "bedrock:GetInferenceProfile"
              Resource:
                - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*"
            - !If
              - HasGuardrailConfig
              - Effect: Allow
                Action:
                  - "bedrock:ApplyGuardrail"
                Resource:
                  - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:guardrail/${BedrockGuardrailId}"
              - !Ref AWS::NoValue
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # LogGroup for configuration_resolver
  ConfigurationResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays


  # Function: configuration_resolver
  ConfigurationResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/configuration_resolver
      Description: Lambda function to manage configuration through GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          CONFIGURATION_TABLE_NAME: !Ref ConfigurationTable
          STACK_NAME: !Ref AWS::StackName
          CONFIGURATION_BUCKET: !Ref ConfigurationBucket
      LoggingConfig:
        LogGroup: !Ref ConfigurationResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ConfigurationTable
        - S3ReadPolicy:
            BucketName: !Ref ConfigurationBucket
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn
            - Effect: Allow
              Action:
                - ssm:GetParameter
                - ssm:PutParameter
              Resource: !Sub "arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/FlowDefinitionArn"


  # LogGroup for copy_to_baseline_resolver
  CopyToBaselineResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays


  # Function: copy_to_baseline_resolver
  CopyToBaselineResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/copy_to_baseline_resolver
      Description: Lambda function to copy files to baseline bucket via GraphQL API
      MemorySize: 512
      Timeout: 300
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          OUTPUT_BUCKET: !Ref OutputBucket
          EVALUATION_BASELINE_BUCKET: !If
            - ShouldCreateEvaluationBaselineBucket
            - !Ref EvaluationBaselineBucket
            - !Ref EvaluationBaselineBucketName
          APPSYNC_API_URL: !GetAtt GraphQLApi.GraphQLUrl
      LoggingConfig:
        LogGroup: !Ref CopyToBaselineResolverFunctionLogGroup
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref OutputBucket
        - S3CrudPolicy:
            BucketName: !If
              - ShouldCreateEvaluationBaselineBucket
              - !Ref EvaluationBaselineBucket
              - !Ref EvaluationBaselineBucketName
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn
        # Allow the function to invoke itself asynchronously
        - Statement:
            - Effect: Allow
              Action:
                - lambda:InvokeFunction
              Resource: !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${AWS::StackName}-CopyToBaseline*"
        # Allow AppSync access for document updates
        - Statement:
            - Effect: Allow
              Action:
                - appsync:GraphQL
              Resource:
                - !Sub "${GraphQLApi.Arn}/types/Mutation/*"


  # LogGroup for create_document_resolver
  CreateDocumentResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays

  # Create Document resolver configuration

  # Function: create_document_resolver
  CreateDocumentResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/create_document_resolver
      Description: Lambda function to create document tracking via GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          TRACKING_TABLE_NAME: !Ref TrackingTable
      LoggingConfig:
        LogGroup: !Ref CreateDocumentResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTable
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # LogGroup for delete_agent_chat_session_resolver
  DeleteAgentChatSessionFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays

  ##########################################################################
  # AppSync Data Sources for Agent Chat Session Management
  ##########################################################################


  # Function: delete_agent_chat_session_resolver
  DeleteAgentChatSessionFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      CodeUri: src/lambda/delete_agent_chat_session_resolver/
      Handler: index.handler
      Runtime: python3.12
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          CHAT_MESSAGES_TABLE: !Ref ChatMessagesTable
          CHAT_SESSIONS_TABLE: !Ref ChatSessionsTable
      LoggingConfig:
        LogGroup: !Ref DeleteAgentChatSessionFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatMessagesTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatSessionsTable
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # DataSource for delete_agent_chat_session_resolver
  DeleteAgentChatSessionDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      Name: DeleteAgentChatSessionDataSource
      Description: Lambda function for deleting agent chat sessions
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt DeleteAgentChatSessionFunction.Arn

  ##########################################################################
  # AppSync Resolvers for Agent Chat Session Management
  ##########################################################################


  # LogGroup for delete_document_resolver
  DeleteDocumentResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays


  # Function: delete_document_resolver
  DeleteDocumentResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/delete_document_resolver
      Description: Lambda function to delete documents via GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          TRACKING_TABLE_NAME: !Ref TrackingTable
          INPUT_BUCKET: !Ref InputBucket
          OUTPUT_BUCKET: !Ref OutputBucket
      LoggingConfig:
        LogGroup: !Ref DeleteDocumentResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTable
        - S3CrudPolicy:
            BucketName: !Ref InputBucket
        - S3CrudPolicy:
            BucketName: !Ref OutputBucket
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # LogGroup for delete_tests
  DeleteTestsResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays


  # Function: delete_tests
  DeleteTestsResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    Properties:
      PermissionsBoundary: !If [HasPermissionsBoundary, !Ref PermissionsBoundaryArn, !Ref AWS::NoValue]
      Handler: index.lambda_handler
      Runtime: python3.12
      CodeUri: ./src/lambda/delete_tests
      Description: Lambda function to delete test runs via GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          TRACKING_TABLE_NAME: !Ref TrackingTable
          DELETE_DOCUMENT_FUNCTION_NAME: !Ref DeleteDocumentResolverFunction
          BASELINE_BUCKET: !If
            - ShouldCreateEvaluationBaselineBucket
            - !Ref EvaluationBaselineBucket
            - !Ref EvaluationBaselineBucketName
      LoggingConfig:
        LogGroup: !Ref DeleteTestsResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTable
        - S3CrudPolicy:
            BucketName: !If
              - ShouldCreateEvaluationBaselineBucket
              - !Ref EvaluationBaselineBucket
              - !Ref EvaluationBaselineBucketName
        - Statement:
            - Effect: Allow
              Action:
                - lambda:InvokeFunction
              Resource: !GetAtt DeleteDocumentResolverFunction.Arn
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # LogGroup for discovery_upload_resolver
  DiscoveryUploadResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays


  # Function: discovery_upload_resolver
  DiscoveryUploadResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/discovery_upload_resolver
      Description: Lambda function to handle discovery document uploads via GraphQL API
      MemorySize: 512
      Timeout: 120
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          DISCOVERY_BUCKET: !Ref DiscoveryBucket
          DISCOVERY_TRACKING_TABLE: !Ref DiscoveryTrackingTable
          DISCOVERY_QUEUE_URL: !Ref DiscoveryQueue
      LoggingConfig:
        LogGroup: !Ref DiscoveryUploadResolverFunctionLogGroup
      Policies:
        - S3WritePolicy:
            BucketName: !Ref DiscoveryBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref DiscoveryTrackingTable
        - SQSSendMessagePolicy:
            QueueName: !GetAtt DiscoveryQueue.QueueName
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # DataSource for discovery_upload_resolver
  DiscoveryUploadResolverDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      Name: DiscoveryUploadResolverDataSource
      Description: Lambda function for discovery document uploads
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt DiscoveryUploadResolverFunction.Arn


  # LogGroup for get_agent_chat_messages_resolver
  GetAgentChatMessagesFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays

  # Lambda function for deleting agent chat sessions

  # Function: get_agent_chat_messages_resolver
  GetAgentChatMessagesFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      CodeUri: src/lambda/get_agent_chat_messages_resolver/
      Handler: index.handler
      Runtime: python3.12
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          CHAT_MESSAGES_TABLE: !Ref ChatMessagesTable
      LoggingConfig:
        LogGroup: !Ref GetAgentChatMessagesFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatMessagesTable
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # DataSource for get_agent_chat_messages_resolver
  GetAgentChatMessagesDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      Name: GetAgentChatMessagesDataSource
      Description: Lambda function for getting agent chat messages
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt GetAgentChatMessagesFunction.Arn


  # LogGroup for get_file_contents_resolver
  GetFileContentsResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays


  # Function: get_file_contents_resolver
  GetFileContentsResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/get_file_contents_resolver
      Description: Lambda function to return file contents via GraphQL API
      MemorySize: 512
      Timeout: 60
      LoggingConfig:
        LogGroup: !Ref GetFileContentsResolverFunctionLogGroup
      Policies:
        - S3ReadPolicy:
            BucketName: !If
              - ShouldCreateEvaluationBaselineBucket
              - !Ref EvaluationBaselineBucket
              - !Ref EvaluationBaselineBucketName
        - S3ReadPolicy:
            BucketName: !Ref InputBucket
        - S3ReadPolicy:
            BucketName: !Ref ConfigurationBucket
        - S3ReadPolicy:
            BucketName: !Ref OutputBucket
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # LogGroup for get_stepfunction_execution_resolver
  GetStepFunctionExecutionResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays


  # Function: get_stepfunction_execution_resolver
  GetStepFunctionExecutionResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W58
            reason: "DLQ not required for AppSync resolver function as GraphQL handles retries"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function as GraphQL handles retries"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      CodeUri: src/lambda/get_stepfunction_execution_resolver/
      Handler: index.lambda_handler
      Runtime: python3.12
      Architectures:
        - x86_64
      MemorySize: 512
      Timeout: 60
      LoggingConfig:
        LogGroup: !Ref GetStepFunctionExecutionResolverFunctionLogGroup
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - states:DescribeExecution
                - states:GetExecutionHistory
              Resource:
                - !Sub
                  - "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:execution:${StateMachineName}*"
                  - StateMachineName: !If
                      - IsPattern3
                      - !GetAtt PATTERN3STACK.Outputs.StateMachineName
                      - !If
                        - IsPattern2
                        - !GetAtt PATTERN2STACK.Outputs.StateMachineName
                        - !GetAtt PATTERN1STACK.Outputs.StateMachineName
        - KMSDecryptPolicy:
            KeyId: !GetAtt CustomerManagedEncryptionKey.Arn
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # Function: ipset_updater
  IPSetUpdaterFunction:
    Type: AWS::Serverless::Function
    Condition: IsWafEnabled
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for Cfn Custom Resource function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      CodeUri: ./src/lambda/ipset_updater
      Handler: index.lambda_handler
      Runtime: python3.12
      Timeout: 300
      MemorySize: 256
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          IPSET_NAME: !Sub ${AWS::StackName}-lambda-service-ips
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - wafv2:GetIPSet
                - wafv2:UpdateIPSet
              Resource: !GetAtt WAFLambdaServiceIPSet.Arn
            - Effect: Allow
              Action:
                - wafv2:ListIPSets
              Resource: !Sub "arn:${AWS::Partition}:wafv2:${AWS::Region}:${AWS::AccountId}:regional/ipset/*"
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: rate(1 day)
            Description: Update Lambda IP ranges daily
            Enabled: true


  # LogGroup for list_agent_chat_sessions_resolver
  ListAgentChatSessionsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays

  # Lambda function for getting agent chat messages

  # Function: list_agent_chat_sessions_resolver
  ListAgentChatSessionsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      CodeUri: src/lambda/list_agent_chat_sessions_resolver/
      Handler: index.handler
      Runtime: python3.12
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          CHAT_SESSIONS_TABLE: !Ref ChatSessionsTable
      LoggingConfig:
        LogGroup: !Ref ListAgentChatSessionsFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatSessionsTable
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # DataSource for list_agent_chat_sessions_resolver
  ListAgentChatSessionsDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      Name: ListAgentChatSessionsDataSource
      Description: Lambda function for listing agent chat sessions
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt ListAgentChatSessionsFunction.Arn


  # Function: list_available_agents
  ListAvailableAgentsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with local agent factory"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with local agent factory"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      CodeUri: src/lambda/list_available_agents/
      Handler: index.handler
      Runtime: python3.12
      Timeout: 30
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          AWS_STACK_NAME: !Ref AWS::StackName
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource:
                - !Ref ExternalMCPAgentsSecret
            - Effect: Allow
              Action:
                - kms:Decrypt
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn
      LoggingConfig:
        LogGroup: !Ref ListAvailableAgentsLogGroup


  # DataSource for list_available_agents
  ListAvailableAgentsDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      Name: ListAvailableAgentsDataSource
      Description: Lambda function for listing available agents
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt ListAvailableAgentsFunction.Arn


  # LogGroup for process_changes_resolver
  ProcessChangesResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays


  # Function: process_changes_resolver
  ProcessChangesResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/process_changes_resolver
      Description: Lambda function to process section changes via GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          TRACKING_TABLE: !Ref TrackingTable
          QUEUE_URL: !Ref DocumentQueue
          DATA_RETENTION_IN_DAYS: !Ref DataRetentionInDays
          WORKING_BUCKET: !Ref WorkingBucket
          INPUT_BUCKET: !Ref InputBucket
          OUTPUT_BUCKET: !Ref OutputBucket
          APPSYNC_API_URL: !GetAtt GraphQLApi.GraphQLUrl
      LoggingConfig:
        LogGroup: !Ref ProcessChangesResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTable
        - SQSSendMessagePolicy:
            QueueName: !GetAtt DocumentQueue.QueueName
        - S3CrudPolicy:
            BucketName: !Ref OutputBucket
        - S3CrudPolicy:
            BucketName: !Ref WorkingBucket
        - Statement:
            - Effect: Allow
              Action:
                - appsync:GraphQL
              Resource:
                - !Sub "${GraphQLApi.Arn}/types/Mutation/*"
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # LogGroup for query_knowledgebase_resolver
  QueryKnowledgeBaseResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays


  # Function: query_knowledgebase_resolver
  QueryKnowledgeBaseResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
          - id: W11
            reason: "Role requires * resource access for Marketplace and CloudWatch Metrics and Logs"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/query_knowledgebase_resolver
      Description: Lambda function to query Bedrock Knowledge Base via GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          KB_ID: !If
            - ShouldUseDocumentKnowledgeBase
            - !GetAtt DOCUMENTKB.Outputs.KnowledgeBaseID
            - ""
          KB_ACCOUNT_ID: !Ref AWS::AccountId
          KB_REGION: !Ref AWS::Region
          MODEL_ID: !Ref KnowledgeBaseModelId
          GUARDRAIL_ID_AND_VERSION:
            !If [
              HasGuardrailConfig,
              !Sub "${BedrockGuardrailId}:${BedrockGuardrailVersion}",
              "",
            ]
      LoggingConfig:
        LogGroup: !Ref QueryKnowledgeBaseResolverFunctionLogGroup
      Policies:
        - Statement:
            - !If
              - ShouldUseDocumentKnowledgeBase
              - Effect: Allow
                Action:
                  - bedrock:Retrieve
                  - bedrock:RetrieveAndGenerate
                Resource: !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/${DOCUMENTKB.Outputs.KnowledgeBaseID}"
              - !Ref AWS::NoValue
            - Effect: Allow
              Action:
                - "bedrock:InvokeModel"
              Resource:
                - !Sub "arn:${AWS::Partition}:bedrock:*::foundation-model/*"
                - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*"
            - Effect: Allow
              Action:
                - "bedrock:GetInferenceProfile"
              Resource:
                - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*"
            - Effect: Allow
              Action:
                - aws-marketplace:Subscribe
                - aws-marketplace:Unsubscribe
                - aws-marketplace:ViewSubscriptions
              Resource: "*"
            - !If
              - HasGuardrailConfig
              - Effect: Allow
                Action:
                  - "bedrock:ApplyGuardrail"
                Resource:
                  - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:guardrail/${BedrockGuardrailId}"
              - !Ref AWS::NoValue
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # LogGroup for reprocess_document_resolver
  ReprocessDocumentResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays


  # Function: reprocess_document_resolver
  ReprocessDocumentResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/reprocess_document_resolver
      Description: Lambda function to reprocess documents via GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          INPUT_BUCKET: !Ref InputBucket
          OUTPUT_BUCKET: !Ref OutputBucket
          QUEUE_URL: !Ref DocumentQueue
          APPSYNC_API_URL: !GetAtt GraphQLApi.GraphQLUrl
          DATA_RETENTION_IN_DAYS: !Ref DataRetentionInDays
      LoggingConfig:
        LogGroup: !Ref ReprocessDocumentResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTable
        - SQSSendMessagePolicy:
            QueueName: !GetAtt DocumentQueue.QueueName
        - S3ReadPolicy:
            BucketName: !Ref InputBucket
        - Statement:
            - Effect: Allow
              Action:
                - appsync:GraphQL
              Resource:
                - !Sub "${GraphQLApi.Arn}/types/Mutation/*"
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # LogGroup for sync_bda_idp_resolver
  SyncBdaIdpResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: IsPattern1
    Properties:
      RetentionInDays: !Ref LogRetentionDays
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn


  # Function: sync_bda_idp_resolver
  SyncBdaIdpResolverFunction:
    Type: AWS::Serverless::Function
    Condition: IsPattern1
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W58
            reason: Lambda function has permission to write CloudWatch Logs via the attached IAM role
          - id: W89
            reason: Lambda function does not need to be deployed inside a VPC
          - id: W92
            reason: Lambda function does not need reserved concurrency
          - id: W11
            reason: CloudWatch does not support resource-level permissions
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/sync_bda_idp_resolver
      Timeout: 300  # 5 minutes for sync operation
      Description: Lambda function to synchronously sync BDA blueprints with IDP classes
      MemorySize: 512
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          CONFIGURATION_TABLE_NAME: !Ref ConfigurationTable
          STACK_NAME: !Ref AWS::StackName
          BDA_PROJECT_ARN: !If
            - HasPattern1BDAProjectArn
            - !Ref Pattern1BDAProjectArn
            - !GetAtt BDASAMPLEPROJECT.Outputs.ProjectArn
      LoggingConfig:
        LogGroup: !Ref SyncBdaIdpResolverFunctionLogGroup
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ConfigurationTable
        - S3ReadPolicy:
            BucketName: !Ref ConfigurationBucket
        - Statement:
            # CloudWatch metrics permission
            - Effect: Allow
              Action: cloudwatch:PutMetricData
              Resource: '*'
            # KMS permissions for encryption
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn
            # BDA permissions for blueprint management
            - Effect: Allow
              Action:
                - bedrock:InvokeDataAutomationAsync
                - bedrock:CreateDataAutomationProject
                - bedrock:UpdateDataAutomationProject
                - bedrock:GetDataAutomationProject
                - bedrock:GetDataAutomationStatus
                - bedrock:GetBlueprint
                - bedrock:UpdateBlueprint
                - bedrock:CreateBlueprint
                - bedrock:CreateBlueprintVersion
                - bedrock:ListBlueprints
                - bedrock:DeleteBlueprint
              Resource:
                - !If
                  - HasPattern1BDAProjectArn
                  - !Ref Pattern1BDAProjectArn
                  - !GetAtt BDASAMPLEPROJECT.Outputs.ProjectArn
                - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:blueprint/*"
                - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:aws:blueprint/*"


  # LogGroup for test_results_resolver
  TestResultsResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays


  # Function: test_results_resolver
  TestResultsResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    Properties:
      PermissionsBoundary: !If [HasPermissionsBoundary, !Ref PermissionsBoundaryArn, !Ref AWS::NoValue]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/test_results_resolver
      Description: GraphQL resolver for test results queries
      MemorySize: 512
      Timeout: 300
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          TRACKING_TABLE: !Ref TrackingTable
          BASELINE_BUCKET: !Ref EvaluationBaselineBucket
          OUTPUT_BUCKET: !Ref OutputBucket
          TEST_RESULT_CACHE_UPDATE_QUEUE_URL: !Ref TestResultCacheUpdateQueue
          ATHENA_DATABASE: !Ref ReportingDatabase
          ATHENA_OUTPUT_LOCATION: !Sub
            - "s3://${Bucket}/athena-results/"
            - Bucket: !If
                - ShouldCreateReportingBucket
                - !Ref ReportingBucket
                - !Ref ReportingBucketName
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt TestResultCacheUpdateQueue.Arn
            BatchSize: 1
      LoggingConfig:
        LogGroup: !Ref TestResultsResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTable
        - S3ReadPolicy:
            BucketName: !Ref EvaluationBaselineBucket
        - S3ReadPolicy:
            BucketName: !Ref OutputBucket
        - S3ReadPolicy:
            BucketName: !If [ShouldCreateReportingBucket, !Ref ReportingBucket, !Ref ReportingBucketName]
        - Statement:
            - Effect: Allow
              Action:
                - s3:PutObject
                - s3:PutObjectAcl
              Resource: !Sub
                - "${BucketArn}/athena-results/*"
                - BucketArn: !If
                    - ShouldCreateReportingBucket
                    - !GetAtt ReportingBucket.Arn
                    - !Sub "arn:${AWS::Partition}:s3:::${ReportingBucketName}"
        - Statement:
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource: !GetAtt TestResultCacheUpdateQueue.Arn
        - Statement:
            - Effect: Allow
              Action:
                - athena:StartQueryExecution
                - athena:GetQueryExecution
                - athena:GetQueryResults
                - athena:StopQueryExecution
              Resource:
                - !Sub "arn:${AWS::Partition}:athena:${AWS::Region}:${AWS::AccountId}:workgroup/primary"
                - !Sub "arn:${AWS::Partition}:athena:${AWS::Region}:${AWS::AccountId}:datacatalog/*"
        - Statement:
            - Effect: Allow
              Action:
                - glue:GetTable
                - glue:GetPartitions
              Resource:
                - !Sub "arn:${AWS::Partition}:glue:${AWS::Region}:${AWS::AccountId}:catalog"
                - !Sub "arn:${AWS::Partition}:glue:${AWS::Region}:${AWS::AccountId}:database/${ReportingDatabase}"
                - !Sub "arn:${AWS::Partition}:glue:${AWS::Region}:${AWS::AccountId}:table/${ReportingDatabase}/*"
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # LogGroup for test_runner
  TestRunnerFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays

  ##########################################################################
  # SQS Queue for test file copying jobs
  ##########################################################################


  # Function: test_runner
  TestRunnerFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary: !If [HasPermissionsBoundary, !Ref PermissionsBoundaryArn, !Ref AWS::NoValue]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/test_runner
      Description: Lambda function to run test sets via GraphQL API
      MemorySize: 256
      Timeout: 300
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          INPUT_BUCKET: !Ref InputBucket
          BASELINE_BUCKET: !If
            - ShouldCreateEvaluationBaselineBucket
            - !Ref EvaluationBaselineBucket
            - !Ref EvaluationBaselineBucketName
          CONFIG_TABLE: !Ref ConfigurationTable
          TRACKING_TABLE: !Ref TrackingTable
          FILE_COPY_QUEUE_URL: !Ref TestFileCopyQueue
      LoggingConfig:
        LogGroup: !Ref TestRunnerFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ConfigurationTable
        - S3CrudPolicy:
            BucketName: !Ref InputBucket
        - S3CrudPolicy:
            BucketName: !If
              - ShouldCreateEvaluationBaselineBucket
              - !Ref EvaluationBaselineBucket
              - !Ref EvaluationBaselineBucketName
        - SQSSendMessagePolicy:
            QueueName: !GetAtt TestFileCopyQueue.QueueName
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # DataSource for test_runner
  TestRunnerDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      Name: TestRunnerDataSource
      Description: Lambda function for running test sets
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt TestRunnerFunction.Arn


  # LogGroup for test_set_resolver
  TestSetResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays


  # Function: test_set_resolver
  TestSetResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    Properties:
      PermissionsBoundary: !If [HasPermissionsBoundary, !Ref PermissionsBoundaryArn, !Ref AWS::NoValue]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/test_set_resolver
      Description: GraphQL resolver for test set mutations
      MemorySize: 256
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          TRACKING_TABLE: !Ref TrackingTable
          INPUT_BUCKET: !Ref InputBucket
          TEST_SET_BUCKET: !Ref TestSetBucket
          TEST_SET_COPY_QUEUE_URL: !Ref TestSetFileCopyQueue
          BASELINE_BUCKET: !If
            - ShouldCreateEvaluationBaselineBucket
            - !Ref EvaluationBaselineBucket
            - !Ref EvaluationBaselineBucketName
      LoggingConfig:
        LogGroup: !Ref TestSetResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTable
        - S3ReadPolicy:
            BucketName: !Ref InputBucket
        - S3ReadPolicy:
            BucketName: !If
              - ShouldCreateEvaluationBaselineBucket
              - !Ref EvaluationBaselineBucket
              - !Ref EvaluationBaselineBucketName
        - SQSSendMessagePolicy:
            QueueName: !GetAtt TestSetFileCopyQueue.QueueName
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # LogGroup for upload_resolver
  UploadResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !GetAtt CustomerManagedEncryptionKey.Arn
      RetentionInDays: !Ref LogRetentionDays

  # AppSync resolver data source

  # Function: upload_resolver
  UploadResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/upload_resolver
      Description: Lambda function to return signed upload URL via GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          INPUT_BUCKET: !Ref InputBucket
      LoggingConfig:
        LogGroup: !Ref UploadResolverFunctionLogGroup
      Policies:
        - S3WritePolicy:
            BucketName: !Ref InputBucket
        - S3WritePolicy:
            BucketName: !Ref ConfigurationBucket
        - S3WritePolicy:
            BucketName: !Ref OutputBucket
        - S3WritePolicy:
            BucketName: !If
              - ShouldCreateEvaluationBaselineBucket
              - !Ref EvaluationBaselineBucket
              - !Ref EvaluationBaselineBucketName
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !GetAtt CustomerManagedEncryptionKey.Arn


  # DataSource for upload_resolver
  UploadResolverDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLApi.ApiId
      Name: UploadResolverDataSource
      Description: Lambda function for generating presigned URLs
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt UploadResolverFunction.Arn

  # AppSync resolver
