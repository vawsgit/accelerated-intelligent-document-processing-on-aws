AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: AppSync Resolvers Nested Stack - GraphQL Schema, DataSources, Resolvers, and Lambda Functions

Parameters:
  # Core AppSync resources from main template
  GraphQLApiId:
    Type: String
    Description: The GraphQL API ID from the main template
  
  GraphQLApiArn:
    Type: String
    Description: The GraphQL API ARN from the main template
  
  GraphQLApiUrl:
    Type: String
    Description: The GraphQL API URL from the main template
  
  # Background worker ARNs (for DataSource invocations)
  AgentChatProcessorFunctionArn:
    Type: String
    Description: ARN of the AgentChatProcessorFunction from main template
  
  AgentProcessorFunctionArn:
    Type: String
    Description: ARN of the AgentProcessorFunction from main template
  
  # DynamoDB Tables
  TrackingTableName:
    Type: String
  
  ConfigurationTableName:
    Type: String
  
  AgentTableName:
    Type: String
  
  ChatMessagesTableName:
    Type: String
  
  ChatSessionsTableName:
    Type: String
  
  IdHelperChatMemoryTableName:
    Type: String
  
  DiscoveryTrackingTableName:
    Type: String
  
  # S3 Buckets
  InputBucketName:
    Type: String
  
  OutputBucketName:
    Type: String
  
  ConfigurationBucketName:
    Type: String
  
  TestSetBucketName:
    Type: String
  
  EvaluationBaselineBucketName:
    Type: String
  
  ReportingBucketName:
    Type: String
  
  WorkingBucketName:
    Type: String
  
  DiscoveryBucketName:
    Type: String
  
  # SQS Queues
  DocumentQueueUrl:
    Type: String
  
  DiscoveryQueueUrl:
    Type: String
  
  TestFileCopyQueueUrl:
    Type: String
  
  TestSetFileCopyQueueUrl:
    Type: String
  
  TestResultCacheUpdateQueueUrl:
    Type: String
  
  # Other resources
  CustomerManagedEncryptionKeyArn:
    Type: String
  
  ReportingDatabaseName:
    Type: String
  
  StateMachineArn:
    Type: String
  
  StateMachineName:
    Type: String
  
  LookupFunctionName:
    Type: String
  
  SaveReportingFunctionName:
    Type: String
  
  # Configuration
  StackName:
    Type: String
  
  LogRetentionDays:
    Type: Number
  
  LogLevel:
    Type: String
  
  DataRetentionInDays:
    Type: Number
  
  PermissionsBoundaryArn:
    Type: String
  
  ExecutionTimeThresholdMs:
    Type: Number
  
  # Conditional flags and parameters
  HasGuardrailConfig:
    Type: String
    AllowedValues: ["true", "false"]
  
  BedrockGuardrailId:
    Type: String
  
  BedrockGuardrailVersion:
    Type: String
  
  ShouldUseDocumentKnowledgeBase:
    Type: String
    AllowedValues: ["true", "false"]
  
  KnowledgeBaseId:
    Type: String
  
  KnowledgeBaseModelId:
    Type: String
    Description: Model ID for Knowledge Base queries
  
  ShouldCreateEvaluationBaselineBucket:
    Type: String
    AllowedValues: ["true", "false"]
  
  ShouldCreateReportingBucket:
    Type: String
    AllowedValues: ["true", "false"]
  
  IsPattern1:
    Type: String
    AllowedValues: ["true", "false"]
  
  Pattern1BDAProjectArn:
    Type: String
  
  HasPattern1BDAProjectArn:
    Type: String
    AllowedValues: ["true", "false"]

Conditions:
  HasPermissionsBoundary: !Not [!Equals [!Ref PermissionsBoundaryArn, ""]]
  HasGuardrail: !Equals [!Ref HasGuardrailConfig, "true"]
  UseDocumentKnowledgeBase: !Equals [!Ref ShouldUseDocumentKnowledgeBase, "true"]
  IsPattern1Enabled: !Equals [!Ref IsPattern1, "true"]
  HasBDAProjectArn: !Equals [!Ref HasPattern1BDAProjectArn, "true"]

Resources:

  ##########################################################################
  # GraphQLSchema
  ##########################################################################
  GraphQLSchema:
    Type: AWS::AppSync::GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DefinitionS3Location: ./src/api/schema.graphql


  ##########################################################################
  # AppSyncServiceRole
  ##########################################################################
  AppSyncServiceRole:
    Type: AWS::IAM::Role
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W76
            reason: "Suppressing W76: SPCM for IAM policy document is higher than 25"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: !Sub "appsync.${AWS::URLSuffix}"
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/service-role/AWSAppSyncPushToCloudWatchLogs"
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TrackingTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${AgentTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DiscoveryTrackingTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ChatMessagesTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ChatSessionsTableName}"
              - Effect: Allow
                Action:
                  - kms:Encrypt
                  - kms:Decrypt
                  - kms:ReEncrypt*
                  - kms:GenerateDataKey*
                  - kms:DescribeKey
                Resource: !Ref CustomerManagedEncryptionKeyArn
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - !GetAtt GetFileContentsResolverFunction.Arn
                  - !GetAtt GetStepFunctionExecutionResolverFunction.Arn
                  - !GetAtt ConfigurationResolverFunction.Arn
                  - !GetAtt UploadResolverFunction.Arn
                  - !GetAtt CopyToBaselineResolverFunction.Arn
                  - !GetAtt CreateDocumentResolverFunction.Arn
                  - !GetAtt DeleteDocumentResolverFunction.Arn
                  - !GetAtt DeleteTestsResolverFunction.Arn
                  - !GetAtt QueryKnowledgeBaseResolverFunction.Arn
                  - !GetAtt ReprocessDocumentResolverFunction.Arn
                  - !GetAtt AbortWorkflowResolverFunction.Arn
                  - !GetAtt ProcessChangesResolverFunction.Arn
                  - !GetAtt AgentChatResolverFunction.Arn
                  - !GetAtt ListAvailableAgentsFunction.Arn
                  - !GetAtt ChatWithDocumentResolverFunction.Arn
                  - !GetAtt DiscoveryUploadResolverFunction.Arn
                  - !GetAtt TestRunnerFunction.Arn
                  - !GetAtt TestResultsResolverFunction.Arn
                  - !GetAtt TestSetResolverFunction.Arn
                  - !GetAtt AgentRequestHandlerFunction.Arn  # <-- Backward Compatibility for error analyzer agent
                  - !GetAtt ListAgentChatSessionsFunction.Arn
                  - !GetAtt GetAgentChatMessagesFunction.Arn
                  - !GetAtt DeleteAgentChatSessionFunction.Arn
                  - !If
                    - IsPattern1Enabled
                    - !GetAtt SyncBdaIdpResolverFunction.Arn
                    - !Ref AWS::NoValue

  # Lambda function for Create Document resolver

  ##########################################################################
  # TrackingTableDataSource
  ##########################################################################
  TrackingTableDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: TrackingTableDataSource
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      DynamoDBConfig:
        TableName: !Ref TrackingTableName
        AwsRegion: !Ref AWS::Region


  ##########################################################################
  # DiscoveryTableDataSource
  ##########################################################################
  DiscoveryTableDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: DiscoveryTableDataSource
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      DynamoDBConfig:
        TableName: !Ref DiscoveryTrackingTableName
        AwsRegion: !Ref AWS::Region


  ##########################################################################
  # ChatMessagesDataSource
  ##########################################################################
  ChatMessagesDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: ChatMessagesDataSource
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      DynamoDBConfig:
        TableName: !Ref ChatMessagesTableName
        AwsRegion: !Ref AWS::Region

  ##########################################################################
  # Backward Compatible for Error Anlayzer Agent 
  ##########################################################################


  ##########################################################################
  # AgentTableDataSource
  ##########################################################################
  AgentTableDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: AgentTableDataSource
      Description: DynamoDB table for agent job tracking
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      DynamoDBConfig:
        TableName: !Ref AgentTableName
        AwsRegion: !Ref AWS::Region



  ##########################################################################
  # NoneDataSource
  ##########################################################################
  NoneDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: NoneDataSource
      Type: NONE


  ##########################################################################
  # AbortWorkflowResolverFunctionLogGroup
  ##########################################################################
  AbortWorkflowResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays


  ##########################################################################
  # AbortWorkflowResolverFunction
  ##########################################################################
  AbortWorkflowResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/abort_workflow_resolver
      Description: Lambda function to abort document workflows via GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          APPSYNC_API_URL: !Ref GraphQLApiUrl
      LoggingConfig:
        LogGroup: !Ref AbortWorkflowResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTableName
        - StepFunctionsExecutionPolicy:
            StateMachineName: !If
              - IsPattern3
              - !Ref StateMachineName
              - !If
                - IsPattern2
                - !Ref StateMachineName
                - !Ref StateMachineName
        - Statement:
            - Effect: Allow
              Action:
                - appsync:GraphQL
              Resource:
                - !Sub "${GraphQLApiArn}/types/Query/*"
                - !Sub "${GraphQLApiArn}/types/Mutation/*"
            - Effect: Allow
              Action:
                - states:StopExecution
              Resource:
                - !If
                  - IsPattern3
                  - !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:execution:${StateMachineName}:*"
                  - !If
                    - IsPattern2
                    - !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:execution:${StateMachineName}:*"
                    - !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:execution:${StateMachineName}:*"
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # AbortWorkflowDataSource
  ##########################################################################
  AbortWorkflowDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: AbortWorkflowDataSource
      Description: Lambda function for aborting document workflows
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt AbortWorkflowResolverFunction.Arn


  ##########################################################################
  # AbortWorkflowResolver
  ##########################################################################
  AbortWorkflowResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt AbortWorkflowDataSource.Name
      TypeName: Mutation
      FieldName: abortWorkflow


  ##########################################################################
  # AgentChatResolverLogGroup
  ##########################################################################
  AgentChatResolverLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays

  # Lambda function for agent chat processor

  ##########################################################################
  # AgentChatResolverFunction
  ##########################################################################
  AgentChatResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W58
            reason: "DLQ not required for AppSeync Resolver function"
          - id: W11
            reason: "Role requires * resource access for Marketplace, CloudWatch Metrics and Logs"
    # checkov:skip=CKV_AWS_116: "DLQ not required for analytics processor as it's invoked asynchronously by request handler with error handling and job status tracking in DynamoDB"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      CodeUri: ./src/lambda/agent_chat_resolver/
      Handler: index.handler
      Runtime: python3.12
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          CHAT_MESSAGES_TABLE: !Ref ChatMessagesTableName
          AGENT_CHAT_PROCESSOR_FUNCTION: !Ref AgentChatProcessorFunctionArn
          DATA_RETENTION_DAYS: !Ref DataRetentionInDays
          CHAT_SESSIONS_TABLE: !Ref ChatSessionsTableName
      LoggingConfig:
        LogGroup: !Ref AgentChatResolverLogGroup
      Policies:
        - Statement:
            Effect: Allow
            Action: lambda:InvokeFunction
            Resource: !Ref AgentChatProcessorFunctionArn
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatMessagesTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatSessionsTableName
        - LambdaInvokePolicy:
            FunctionName: !Ref AgentChatProcessorFunctionArn
        - Statement:
            Effect: Allow
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # AgentChatResolverDataSource
  ##########################################################################
  AgentChatResolverDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: AgentChatResolverDataSource
      Description: Lambda function for handling agent chat messages
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt AgentChatResolverFunction.Arn


  ##########################################################################
  # AgentChatDataSource
  ##########################################################################
  AgentChatDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: AgentChatDataSource
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt AgentChatResolverFunction.Arn


  ##########################################################################
  # SendAgentChatMessageResolver
  ##########################################################################
  SendAgentChatMessageResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Mutation
      FieldName: sendAgentChatMessage
      DataSourceName: !GetAtt AgentChatDataSource.Name
      RequestMappingTemplate: |
        {
          "version": "2017-02-28",
          "operation": "Invoke",
          "payload": {
            "arguments": $util.toJson($context.arguments),
            "identity": {
              "username": $util.toJson($context.identity.username),
              "sub": $util.toJson($context.identity.sub),
              "sourceIp": $util.toJson($context.identity.sourceIp),
              "userArn": $util.toJson($context.identity.userArn),
              "accountId": $util.toJson($context.identity.accountId),  
              "cognitoIdentityPoolId": $util.toJson($context.identity.cognitoIdentityPoolId),
              "cognitoIdentityId": $util.toJson($context.identity.cognitoIdentityId),
              "userPoolUserId": $util.toJson($context.identity.claims.sub),
              "claims": $util.toJson($context.identity.claims)
            }
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
            $util.error($ctx.error.message, $ctx.error.type)
        #end
        #if($ctx.result)
            $util.toJson($ctx.result)
        #else
            $util.error("No response from Lambda")
        #end


  ##########################################################################
  # OnAgentChatMessageUpdateResolver
  ##########################################################################
  OnAgentChatMessageUpdateResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Subscription
      FieldName: onAgentChatMessageUpdate
      DataSourceName: !GetAtt NoneDataSource.Name
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "payload": {}
        }
      ResponseMappingTemplate: |
        #if($context.arguments.sessionId && $context.source.sessionId)
          #if($context.arguments.sessionId == $context.source.sessionId)
            $util.toJson($context.source)
          #else
            #set($result = $util.appendError("Session ID does not match", "Unauthorized"))
            $util.toJson(null)
          #end
        #else
          $util.toJson($context.source)
        #end     


  ##########################################################################
  # AgentRequestHandlerLogGroup
  ##########################################################################
  AgentRequestHandlerLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-AgentRequestHandler"
      RetentionInDays: !Ref LogRetentionDays
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
  

  ##########################################################################
  # AgentRequestHandlerFunction
  ##########################################################################
  AgentRequestHandlerFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for analytics request handler as it's invoked synchronously via AppSync and errors are handled by the caller"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      CodeUri: ./src/lambda/agent_request_handler/
      Handler: index.handler
      Runtime: python3.12
      Timeout: 30
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          AGENT_TABLE: !Ref AgentTableName
          AGENT_PROCESSOR_FUNCTION: !Ref AgentProcessorFunctionArn
          DATA_RETENTION_DAYS: !Ref DataRetentionInDays
      LoggingConfig:
        LogGroup: !Ref AgentRequestHandlerLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref AgentTableName
        - LambdaInvokePolicy:
            FunctionName: !Ref AgentProcessorFunctionArn
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn

  # Lambda function for agent processor

  ##########################################################################
  # AgentRequestHandlerDataSource
  ##########################################################################
  AgentRequestHandlerDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: AgentRequestHandlerDataSource
      Description: Lambda function for handling agent query requests
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt AgentRequestHandlerFunction.Arn


  ##########################################################################
  # SubmitAgentQueryResolver
  ##########################################################################
  SubmitAgentQueryResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Query
      FieldName: submitAgentQuery
      DataSourceName: !GetAtt AgentRequestHandlerDataSource.Name

  ##########################################################################
  # External Client
  ##########################################################################


  ##########################################################################
  # ChatWithDocumentResolverFunctionLogGroup
  ##########################################################################
  ChatWithDocumentResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays


  ##########################################################################
  # ChatWithDocumentResolverFunction
  ##########################################################################
  ChatWithDocumentResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
          - id: W11
            reason: "Role requires * resource access for CloudWatch Metrics and Logs"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/chat_with_document_resolver
      Description: Lambda function to chat with the document via GraphQL API
      MemorySize: 512
      Timeout: 120
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          OUTPUT_BUCKET: !Ref OutputBucketName
          CONFIGURATION_TABLE_NAME: !Ref ConfigurationTableName
          TRACKING_TABLE_NAME: !Ref TrackingTableName
          GUARDRAIL_ID_AND_VERSION:
            !If [
              HasGuardrail,
              !Sub "${BedrockGuardrailId}:${BedrockGuardrailVersion}",
              "",
            ]
      LoggingConfig:
        LogGroup: !Ref ChatWithDocumentResolverFunctionLogGroup
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref OutputBucketName
        - DynamoDBCrudPolicy:
            TableName: !Ref ConfigurationTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTableName
        - Statement:
            - !If
              - UseDocumentKnowledgeBase
              - Effect: Allow
                Action:
                  - bedrock:Retrieve
                  - bedrock:RetrieveAndGenerate
                Resource: !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/${KnowledgeBaseId}"
              - !Ref AWS::NoValue
            - Effect: Allow
              Action:
                - "bedrock:InvokeModel"
              Resource:
                - !Sub "arn:${AWS::Partition}:bedrock:*::foundation-model/*"
                - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*"
            - Effect: Allow
              Action:
                - aws-marketplace:Subscribe
                - aws-marketplace:Unsubscribe
                - aws-marketplace:ViewSubscriptions
              Resource: "*"
            - Effect: Allow
              Action:
                - cloudwatch:PutMetricData
              Resource: "*"
            - Effect: Allow
              Action:
                - "bedrock:GetInferenceProfile"
              Resource:
                - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*"
            - !If
              - HasGuardrail
              - Effect: Allow
                Action:
                  - "bedrock:ApplyGuardrail"
                Resource:
                  - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:guardrail/${BedrockGuardrailId}"
              - !Ref AWS::NoValue
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # ChatWithDocumentDataSource
  ##########################################################################
  ChatWithDocumentDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: ChatWithDocument
      Description: Lambda function to chat with document
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt ChatWithDocumentResolverFunction.Arn


  ##########################################################################
  # ChatWithDocumentResolver
  ##########################################################################
  ChatWithDocumentResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt ChatWithDocumentDataSource.Name
      TypeName: Query
      FieldName: chatWithDocument

  ##########################################################################
  # WebUI build and deployment
  ##########################################################################


  ##########################################################################
  # ConfigurationResolverFunctionLogGroup
  ##########################################################################
  ConfigurationResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays


  ##########################################################################
  # ConfigurationResolverFunction
  ##########################################################################
  ConfigurationResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/configuration_resolver
      Description: Lambda function to manage configuration through GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          CONFIGURATION_TABLE_NAME: !Ref ConfigurationTableName
          STACK_NAME: !Ref StackName
          CONFIGURATION_BUCKET: !Ref ConfigurationBucketName
      LoggingConfig:
        LogGroup: !Ref ConfigurationResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ConfigurationTableName
        - S3ReadPolicy:
            BucketName: !Ref ConfigurationBucketName
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn
            - Effect: Allow
              Action:
                - ssm:GetParameter
                - ssm:PutParameter
              Resource: !Sub "arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/FlowDefinitionArn"


  ##########################################################################
  # ConfigurationDataSource
  ##########################################################################
  ConfigurationDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: ConfigurationDataSource
      Description: Lambda function to manage configuration via GraphQL API
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt ConfigurationResolverFunction.Arn


  ##########################################################################
  # GetConfigurationResolver
  ##########################################################################
  GetConfigurationResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt ConfigurationDataSource.Name
      TypeName: Query
      FieldName: getConfiguration


  ##########################################################################
  # UpdateConfigurationResolver
  ##########################################################################
  UpdateConfigurationResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt ConfigurationDataSource.Name
      TypeName: Mutation
      FieldName: updateConfiguration


  ##########################################################################
  # ListConfigurationLibraryResolver
  ##########################################################################
  ListConfigurationLibraryResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt ConfigurationDataSource.Name
      TypeName: Query
      FieldName: listConfigurationLibrary


  ##########################################################################
  # GetConfigurationLibraryFileResolver
  ##########################################################################
  GetConfigurationLibraryFileResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt ConfigurationDataSource.Name
      TypeName: Query
      FieldName: getConfigurationLibraryFile


  ##########################################################################
  # GetPricingResolver
  ##########################################################################
  GetPricingResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt ConfigurationDataSource.Name
      TypeName: Query
      FieldName: getPricing


  ##########################################################################
  # UpdatePricingResolver
  ##########################################################################
  UpdatePricingResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt ConfigurationDataSource.Name
      TypeName: Mutation
      FieldName: updatePricing


  ##########################################################################
  # RestoreDefaultPricingResolver
  ##########################################################################
  RestoreDefaultPricingResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt ConfigurationDataSource.Name
      TypeName: Mutation
      FieldName: restoreDefaultPricing


  ##########################################################################
  # CopyToBaselineResolverFunctionLogGroup
  ##########################################################################
  CopyToBaselineResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays


  ##########################################################################
  # CopyToBaselineResolverFunction
  ##########################################################################
  CopyToBaselineResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/copy_to_baseline_resolver
      Description: Lambda function to copy files to baseline bucket via GraphQL API
      MemorySize: 512
      Timeout: 300
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          OUTPUT_BUCKET: !Ref OutputBucketName
          EVALUATION_BASELINE_BUCKET: !If
            - ShouldCreateEvaluationBaselineBucket
            - !Ref EvaluationBaselineBucketName
            - !Ref EvaluationBaselineBucketName
          APPSYNC_API_URL: !Ref GraphQLApiUrl
      LoggingConfig:
        LogGroup: !Ref CopyToBaselineResolverFunctionLogGroup
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref OutputBucketName
        - S3CrudPolicy:
            BucketName: !If
              - ShouldCreateEvaluationBaselineBucket
              - !Ref EvaluationBaselineBucketName
              - !Ref EvaluationBaselineBucketName
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn
        # Allow the function to invoke itself asynchronously
        - Statement:
            - Effect: Allow
              Action:
                - lambda:InvokeFunction
              Resource: !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${AWS::StackName}-CopyToBaseline*"
        # Allow AppSync access for document updates
        - Statement:
            - Effect: Allow
              Action:
                - appsync:GraphQL
              Resource:
                - !Sub "${GraphQLApiArn}/types/Mutation/*"


  ##########################################################################
  # CopyToBaselineDataSource
  ##########################################################################
  CopyToBaselineDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: CopyToBaselineDataSource
      Description: Lambda function for copying files to baseline bucket
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt CopyToBaselineResolverFunction.Arn


  ##########################################################################
  # CopyToBaselineResolver
  ##########################################################################
  CopyToBaselineResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt CopyToBaselineDataSource.Name
      TypeName: Mutation
      FieldName: copyToBaseline


  ##########################################################################
  # CreateDocumentResolverFunctionLogGroup
  ##########################################################################
  CreateDocumentResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays

  # Create Document resolver configuration

  ##########################################################################
  # CreateDocumentResolverFunction
  ##########################################################################
  CreateDocumentResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/create_document_resolver
      Description: Lambda function to create document tracking via GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          TRACKING_TABLE_NAME: !Ref TrackingTableName
      LoggingConfig:
        LogGroup: !Ref CreateDocumentResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTableName
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # CreateDocumentDataSource
  ##########################################################################
  CreateDocumentDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: CreateDocumentDataSource
      Description: Lambda function for creating document tracking records
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt CreateDocumentResolverFunction.Arn


  ##########################################################################
  # CreateDocumentResolver
  ##########################################################################
  CreateDocumentResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Mutation
      FieldName: createDocument
      DataSourceName: !GetAtt CreateDocumentDataSource.Name

  # Data source for Create Document resolver

  ##########################################################################
  # DeleteAgentChatSessionFunctionLogGroup
  ##########################################################################
  DeleteAgentChatSessionFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays

  ##########################################################################
  # AppSync Data Sources for Agent Chat Session Management
  ##########################################################################


  ##########################################################################
  # DeleteAgentChatSessionFunction
  ##########################################################################
  DeleteAgentChatSessionFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      CodeUri: ./src/lambda/delete_agent_chat_session_resolver/
      Handler: index.handler
      Runtime: python3.12
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          CHAT_MESSAGES_TABLE: !Ref ChatMessagesTableName
          CHAT_SESSIONS_TABLE: !Ref ChatSessionsTableName
      LoggingConfig:
        LogGroup: !Ref DeleteAgentChatSessionFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatMessagesTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatSessionsTableName
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # DeleteAgentChatSessionDataSource
  ##########################################################################
  DeleteAgentChatSessionDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: DeleteAgentChatSessionDataSource
      Description: Lambda function for deleting agent chat sessions
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt DeleteAgentChatSessionFunction.Arn

  ##########################################################################
  # AppSync Resolvers for Agent Chat Session Management
  ##########################################################################


  ##########################################################################
  # DeleteChatSessionResolver
  ##########################################################################
  DeleteChatSessionResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Mutation
      FieldName: deleteChatSession
      DataSourceName: !GetAtt DeleteAgentChatSessionDataSource.Name

  # Lambda function for listing available agents

  ##########################################################################
  # DeleteDocumentResolverFunctionLogGroup
  ##########################################################################
  DeleteDocumentResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays


  ##########################################################################
  # DeleteDocumentResolverFunction
  ##########################################################################
  DeleteDocumentResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/delete_document_resolver
      Description: Lambda function to delete documents via GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          TRACKING_TABLE_NAME: !Ref TrackingTableName
          INPUT_BUCKET: !Ref InputBucketName
          OUTPUT_BUCKET: !Ref OutputBucketName
      LoggingConfig:
        LogGroup: !Ref DeleteDocumentResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTableName
        - S3CrudPolicy:
            BucketName: !Ref InputBucketName
        - S3CrudPolicy:
            BucketName: !Ref OutputBucketName
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # DeleteDocumentDataSource
  ##########################################################################
  DeleteDocumentDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: DeleteDocumentDataSource
      Description: Lambda function for deleting documents
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt DeleteDocumentResolverFunction.Arn


  ##########################################################################
  # DeleteDocumentResolver
  ##########################################################################
  DeleteDocumentResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt DeleteDocumentDataSource.Name
      TypeName: Mutation
      FieldName: deleteDocument


  ##########################################################################
  # DeleteTestsResolverFunctionLogGroup
  ##########################################################################
  DeleteTestsResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays


  ##########################################################################
  # DeleteTestsResolverFunction
  ##########################################################################
  DeleteTestsResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    Properties:
      PermissionsBoundary: !If [HasPermissionsBoundary, !Ref PermissionsBoundaryArn, !Ref AWS::NoValue]
      Handler: index.lambda_handler
      Runtime: python3.12
      CodeUri: ./src/lambda/delete_tests
      Description: Lambda function to delete test runs via GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          TRACKING_TABLE_NAME: !Ref TrackingTableName
          DELETE_DOCUMENT_FUNCTION_NAME: !Ref DeleteDocumentResolverFunction
          BASELINE_BUCKET: !If
            - ShouldCreateEvaluationBaselineBucket
            - !Ref EvaluationBaselineBucketName
            - !Ref EvaluationBaselineBucketName
      LoggingConfig:
        LogGroup: !Ref DeleteTestsResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTableName
        - S3CrudPolicy:
            BucketName: !If
              - ShouldCreateEvaluationBaselineBucket
              - !Ref EvaluationBaselineBucketName
              - !Ref EvaluationBaselineBucketName
        - Statement:
            - Effect: Allow
              Action:
                - lambda:InvokeFunction
              Resource: !GetAtt DeleteDocumentResolverFunction.Arn
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # DeleteTestsDataSource
  ##########################################################################
  DeleteTestsDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: DeleteTestsDataSource
      Description: Lambda function for deleting test runs
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt DeleteTestsResolverFunction.Arn


  ##########################################################################
  # DeleteTestsResolver
  ##########################################################################
  DeleteTestsResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt DeleteTestsDataSource.Name
      TypeName: Mutation
      FieldName: deleteTests


  ##########################################################################
  # DiscoveryUploadResolverFunctionLogGroup
  ##########################################################################
  DiscoveryUploadResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays


  ##########################################################################
  # DiscoveryUploadResolverFunction
  ##########################################################################
  DiscoveryUploadResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/discovery_upload_resolver
      Description: Lambda function to handle discovery document uploads via GraphQL API
      MemorySize: 512
      Timeout: 120
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          DISCOVERY_BUCKET: !Ref DiscoveryBucketName
          DISCOVERY_TRACKING_TABLE: !Ref DiscoveryTrackingTableName
          DISCOVERY_QUEUE_URL: !Ref DiscoveryQueueUrl
      LoggingConfig:
        LogGroup: !Ref DiscoveryUploadResolverFunctionLogGroup
      Policies:
        - S3WritePolicy:
            BucketName: !Ref DiscoveryBucketName
        - DynamoDBCrudPolicy:
            TableName: !Ref DiscoveryTrackingTableName
        - SQSSendMessagePolicy:
            QueueName: !Select [5, !Split ["/", !Ref DiscoveryQueueUrl]]
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # DiscoveryUploadResolverDataSource
  ##########################################################################
  DiscoveryUploadResolverDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: DiscoveryUploadResolverDataSource
      Description: Lambda function for discovery document uploads
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt DiscoveryUploadResolverFunction.Arn


  ##########################################################################
  # DiscoveryUploadDocumentResolver
  ##########################################################################
  DiscoveryUploadDocumentResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt DiscoveryUploadResolverDataSource.Name
      TypeName: Mutation
      FieldName: uploadDiscoveryDocument

  ##########################################################################
  # Discovery Jobs List Resolver
  ##########################################################################

  ##########################################################################
  # DiscoveryJobsResolver
  ##########################################################################
  DiscoveryJobsResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Query
      FieldName: listDiscoveryJobs
      DataSourceName: !GetAtt DiscoveryTableDataSource.Name
      RequestMappingTemplate: |
        {
            "version": "2018-05-29",
            "operation": "Scan",
            "limit": 50,
            "consistentRead": false,
            "select": "ALL_ATTRIBUTES"
        }
      ResponseMappingTemplate: |
        {
            "DiscoveryJobs": $util.toJson($ctx.result.items),
            "nextToken": $util.toJson($ctx.result.nextToken)
        }

  ##########################################################################
  # Update Discovery Job Status Resolver
  ##########################################################################

  ##########################################################################
  # UpdateDiscoveryJobStatusResolver
  ##########################################################################
  UpdateDiscoveryJobStatusResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Mutation
      FieldName: updateDiscoveryJobStatus
      DataSourceName: !GetAtt DiscoveryTableDataSource.Name
      RequestMappingTemplate: |-
        ## Validate status is one of the allowed values
        #set($validStatuses = ["PENDING", "IN_PROGRESS", "COMPLETED", "FAILED"])
        #if(!$validStatuses.contains($ctx.args.status))
          $util.error("Invalid status value. Status must be one of: PENDING, IN_PROGRESS, COMPLETED, FAILED", "ValidationException")
        #end

        #set($expNames = {})
        #set($expValues = {})

        ## Set status (required)
        $util.qr($expNames.put("#status", "status"))
        $util.qr($expValues.put(":status", $util.dynamodb.toDynamoDB($ctx.args.status)))
        #set($updateExpression = "SET #status = :status")

        ## Set errorMessage (optional)
        #if($ctx.args.errorMessage)
          $util.qr($expNames.put("#errorMessage", "errorMessage"))
          $util.qr($expValues.put(":errorMessage", $util.dynamodb.toDynamoDB($ctx.args.errorMessage)))
          #set($updateExpression = "${updateExpression}, #errorMessage = :errorMessage")
        #end

        ## Set updatedAt to current timestamp
        $util.qr($expNames.put("#updatedAt", "updatedAt"))
        $util.qr($expValues.put(":updatedAt", $util.dynamodb.toDynamoDB($util.time.nowISO8601())))
        #set($updateExpression = "${updateExpression}, #updatedAt = :updatedAt")

        ## Set completedAt when status is COMPLETED or FAILED
        #if($ctx.args.status == "COMPLETED" || $ctx.args.status == "FAILED")
          $util.qr($expNames.put("#completedAt", "completedAt"))
          $util.qr($expValues.put(":completedAt", $util.dynamodb.toDynamoDB($util.time.nowISO8601())))
          #set($updateExpression = "${updateExpression}, #completedAt = :completedAt")
        #end

        {
          "version": "2018-05-29",
          "operation": "UpdateItem",
          "key": {
            "jobId": $util.dynamodb.toDynamoDBJson($ctx.args.jobId)
          },
          "update": {
            "expression": "$updateExpression",
            "expressionNames": $utils.toJson($expNames),
            "expressionValues": $utils.toJson($expValues)
          }
        }
      ResponseMappingTemplate: |-
        $util.toJson($ctx.result)

  ##########################################################################
  # Discovery Processor Function
  ##########################################################################


  ##########################################################################
  # GetAgentChatMessagesFunctionLogGroup
  ##########################################################################
  GetAgentChatMessagesFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays

  # Lambda function for deleting agent chat sessions

  ##########################################################################
  # GetAgentChatMessagesFunction
  ##########################################################################
  GetAgentChatMessagesFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      CodeUri: ./src/lambda/get_agent_chat_messages_resolver/
      Handler: index.handler
      Runtime: python3.12
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          CHAT_MESSAGES_TABLE: !Ref ChatMessagesTableName
      LoggingConfig:
        LogGroup: !Ref GetAgentChatMessagesFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatMessagesTableName
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # GetAgentChatMessagesDataSource
  ##########################################################################
  GetAgentChatMessagesDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: GetAgentChatMessagesDataSource
      Description: Lambda function for getting agent chat messages
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt GetAgentChatMessagesFunction.Arn


  ##########################################################################
  # GetChatMessagesResolver
  ##########################################################################
  GetChatMessagesResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Query
      FieldName: getChatMessages
      DataSourceName: !GetAtt GetAgentChatMessagesDataSource.Name


  ##########################################################################
  # GetFileContentsResolverFunctionLogGroup
  ##########################################################################
  GetFileContentsResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays


  ##########################################################################
  # GetFileContentsResolverFunction
  ##########################################################################
  GetFileContentsResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/get_file_contents_resolver
      Description: Lambda function to return file contents via GraphQL API
      MemorySize: 512
      Timeout: 60
      LoggingConfig:
        LogGroup: !Ref GetFileContentsResolverFunctionLogGroup
      Policies:
        - S3ReadPolicy:
            BucketName: !If
              - ShouldCreateEvaluationBaselineBucket
              - !Ref EvaluationBaselineBucketName
              - !Ref EvaluationBaselineBucketName
        - S3ReadPolicy:
            BucketName: !Ref InputBucketName
        - S3ReadPolicy:
            BucketName: !Ref ConfigurationBucketName
        - S3ReadPolicy:
            BucketName: !Ref OutputBucketName
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # GetFileContentsDataSource
  ##########################################################################
  GetFileContentsDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: GetFileContents
      Description: Lambda function to return file contents via GraphQL API
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt GetFileContentsResolverFunction.Arn


  ##########################################################################
  # GetFileContentsResolver
  ##########################################################################
  GetFileContentsResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt GetFileContentsDataSource.Name
      TypeName: Query
      FieldName: getFileContents


  ##########################################################################
  # GetStepFunctionExecutionResolverFunctionLogGroup
  ##########################################################################
  GetStepFunctionExecutionResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays


  ##########################################################################
  # GetStepFunctionExecutionResolverFunction
  ##########################################################################
  GetStepFunctionExecutionResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W58
            reason: "DLQ not required for AppSync resolver function as GraphQL handles retries"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function as GraphQL handles retries"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      CodeUri: ./src/lambda/get_stepfunction_execution_resolver/
      Handler: index.lambda_handler
      Runtime: python3.12
      Architectures:
        - x86_64
      MemorySize: 512
      Timeout: 60
      LoggingConfig:
        LogGroup: !Ref GetStepFunctionExecutionResolverFunctionLogGroup
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - states:DescribeExecution
                - states:GetExecutionHistory
              Resource:
                - !Sub
                  - "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:execution:${StateMachineName}*"
                  - StateMachineName: !If
                      - IsPattern3
                      - !Ref StateMachineName
                      - !If
                        - IsPattern2
                        - !Ref StateMachineName
                        - !Ref StateMachineName
        - KMSDecryptPolicy:
            KeyId: !Ref CustomerManagedEncryptionKeyArn
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # GetStepFunctionExecutionDataSource
  ##########################################################################
  GetStepFunctionExecutionDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: GetStepFunctionExecution
      Description: Lambda function to return Step Functions execution details via GraphQL API
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt GetStepFunctionExecutionResolverFunction.Arn


  ##########################################################################
  # GetStepFunctionExecutionResolver
  ##########################################################################
  GetStepFunctionExecutionResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt GetStepFunctionExecutionDataSource.Name
      TypeName: Query
      FieldName: getStepFunctionExecution


  ##########################################################################
  # ListAgentChatSessionsFunctionLogGroup
  ##########################################################################
  ListAgentChatSessionsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays

  # Lambda function for getting agent chat messages

  ##########################################################################
  # ListAgentChatSessionsFunction
  ##########################################################################
  ListAgentChatSessionsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      CodeUri: ./src/lambda/list_agent_chat_sessions_resolver/
      Handler: index.handler
      Runtime: python3.12
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          CHAT_SESSIONS_TABLE: !Ref ChatSessionsTableName
      LoggingConfig:
        LogGroup: !Ref ListAgentChatSessionsFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatSessionsTableName
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # ListAgentChatSessionsDataSource
  ##########################################################################
  ListAgentChatSessionsDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: ListAgentChatSessionsDataSource
      Description: Lambda function for listing agent chat sessions
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt ListAgentChatSessionsFunction.Arn


  ##########################################################################
  # ListChatSessionsResolver
  ##########################################################################
  ListChatSessionsResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Query
      FieldName: listChatSessions
      DataSourceName: !GetAtt ListAgentChatSessionsDataSource.Name
      

  ##########################################################################
  # ListAvailableAgentsLogGroup
  ##########################################################################
  ListAvailableAgentsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays

  # AppSync resolvers for agent operations

  ##########################################################################
  # ListAvailableAgentsFunction
  ##########################################################################
  ListAvailableAgentsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with local agent factory"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with local agent factory"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      CodeUri: ./src/lambda/list_available_agents/
      Handler: index.handler
      Runtime: python3.12
      Timeout: 30
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          AWS_STACK_NAME: !Ref StackName
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource:
                - !Sub "arn:${AWS::Partition}:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${StackName}/external-mcp-agents/credentials-??????"
            - Effect: Allow
              Action:
                - kms:Decrypt
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn
      LoggingConfig:
        LogGroup: !Ref ListAvailableAgentsLogGroup


  ##########################################################################
  # ListAvailableAgentsDataSource
  ##########################################################################
  ListAvailableAgentsDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: ListAvailableAgentsDataSource
      Description: Lambda function for listing available agents
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt ListAvailableAgentsFunction.Arn


  ##########################################################################
  # ListAvailableAgentsResolver
  ##########################################################################
  ListAvailableAgentsResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Query
      FieldName: listAvailableAgents
      DataSourceName: !GetAtt ListAvailableAgentsDataSource.Name


  ##########################################################################
  # ProcessChangesResolverFunctionLogGroup
  ##########################################################################
  ProcessChangesResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays


  ##########################################################################
  # ProcessChangesResolverFunction
  ##########################################################################
  ProcessChangesResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/process_changes_resolver
      Description: Lambda function to process section changes via GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          TRACKING_TABLE: !Ref TrackingTableName
          QUEUE_URL: !Ref DocumentQueueUrl
          DATA_RETENTION_IN_DAYS: !Ref DataRetentionInDays
          WORKING_BUCKET: !Ref WorkingBucketName
          INPUT_BUCKET: !Ref InputBucketName
          OUTPUT_BUCKET: !Ref OutputBucketName
          APPSYNC_API_URL: !Ref GraphQLApiUrl
      LoggingConfig:
        LogGroup: !Ref ProcessChangesResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTableName
        - SQSSendMessagePolicy:
            QueueName: !Select [5, !Split ["/", !Ref DocumentQueueUrl]]
        - S3CrudPolicy:
            BucketName: !Ref OutputBucketName
        - S3CrudPolicy:
            BucketName: !Ref WorkingBucketName
        - Statement:
            - Effect: Allow
              Action:
                - appsync:GraphQL
              Resource:
                - !Sub "${GraphQLApiArn}/types/Mutation/*"
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # ProcessChangesDataSource
  ##########################################################################
  ProcessChangesDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: ProcessChangesDataSource
      Description: Lambda function for processing section changes
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt ProcessChangesResolverFunction.Arn


  ##########################################################################
  # ProcessChangesResolver
  ##########################################################################
  ProcessChangesResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt ProcessChangesDataSource.Name
      TypeName: Mutation
      FieldName: processChanges


  ##########################################################################
  # QueryKnowledgeBaseResolverFunctionLogGroup
  ##########################################################################
  QueryKnowledgeBaseResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays


  ##########################################################################
  # QueryKnowledgeBaseResolverFunction
  ##########################################################################
  QueryKnowledgeBaseResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
          - id: W11
            reason: "Role requires * resource access for Marketplace and CloudWatch Metrics and Logs"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/query_knowledgebase_resolver
      Description: Lambda function to query Bedrock Knowledge Base via GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          KB_ID: !If
            - UseDocumentKnowledgeBase
            - !Ref KnowledgeBaseId
            - ""
          KB_ACCOUNT_ID: !Ref AWS::AccountId
          KB_REGION: !Ref AWS::Region
          MODEL_ID: !Ref KnowledgeBaseModelId
          GUARDRAIL_ID_AND_VERSION:
            !If [
              HasGuardrail,
              !Sub "${BedrockGuardrailId}:${BedrockGuardrailVersion}",
              "",
            ]
      LoggingConfig:
        LogGroup: !Ref QueryKnowledgeBaseResolverFunctionLogGroup
      Policies:
        - Statement:
            - !If
              - UseDocumentKnowledgeBase
              - Effect: Allow
                Action:
                  - bedrock:Retrieve
                  - bedrock:RetrieveAndGenerate
                Resource: !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/${KnowledgeBaseId}"
              - !Ref AWS::NoValue
            - Effect: Allow
              Action:
                - "bedrock:InvokeModel"
              Resource:
                - !Sub "arn:${AWS::Partition}:bedrock:*::foundation-model/*"
                - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*"
            - Effect: Allow
              Action:
                - "bedrock:GetInferenceProfile"
              Resource:
                - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*"
            - Effect: Allow
              Action:
                - aws-marketplace:Subscribe
                - aws-marketplace:Unsubscribe
                - aws-marketplace:ViewSubscriptions
              Resource: "*"
            - !If
              - HasGuardrail
              - Effect: Allow
                Action:
                  - "bedrock:ApplyGuardrail"
                Resource:
                  - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:guardrail/${BedrockGuardrailId}"
              - !Ref AWS::NoValue
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # QueryKnowledgeBaseDataSource
  ##########################################################################
  QueryKnowledgeBaseDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: QueryKnowledgeBase
      Description: Lambda function to query Bedrock Knowledge Base
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt QueryKnowledgeBaseResolverFunction.Arn


  ##########################################################################
  # QueryKnowledgeBaseResolver
  ##########################################################################
  QueryKnowledgeBaseResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt QueryKnowledgeBaseDataSource.Name
      TypeName: Query
      FieldName: queryKnowledgeBase

  ##########################################################################
  # Chat With Document Resolver
  ##########################################################################


  ##########################################################################
  # ReprocessDocumentResolverFunctionLogGroup
  ##########################################################################
  ReprocessDocumentResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays


  ##########################################################################
  # ReprocessDocumentResolverFunction
  ##########################################################################
  ReprocessDocumentResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/reprocess_document_resolver
      Description: Lambda function to reprocess documents via GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          INPUT_BUCKET: !Ref InputBucketName
          OUTPUT_BUCKET: !Ref OutputBucketName
          QUEUE_URL: !Ref DocumentQueueUrl
          APPSYNC_API_URL: !Ref GraphQLApiUrl
          DATA_RETENTION_IN_DAYS: !Ref DataRetentionInDays
      LoggingConfig:
        LogGroup: !Ref ReprocessDocumentResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTableName
        - SQSSendMessagePolicy:
            QueueName: !Select [5, !Split ["/", !Ref DocumentQueueUrl]]
        - S3ReadPolicy:
            BucketName: !Ref InputBucketName
        - Statement:
            - Effect: Allow
              Action:
                - appsync:GraphQL
              Resource:
                - !Sub "${GraphQLApiArn}/types/Mutation/*"
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # ReprocessDocumentDataSource
  ##########################################################################
  ReprocessDocumentDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: ReprocessDocumentDataSource
      Description: Lambda function for reprocessing documents
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt ReprocessDocumentResolverFunction.Arn


  ##########################################################################
  # ReprocessDocumentResolver
  ##########################################################################
  ReprocessDocumentResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt ReprocessDocumentDataSource.Name
      TypeName: Mutation
      FieldName: reprocessDocument


  ##########################################################################
  # SyncBdaIdpResolverFunctionLogGroup
  ##########################################################################
  SyncBdaIdpResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: IsPattern1Enabled
    Properties:
      RetentionInDays: !Ref LogRetentionDays
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # SyncBdaIdpResolverFunction
  ##########################################################################
  SyncBdaIdpResolverFunction:
    Type: AWS::Serverless::Function
    Condition: IsPattern1Enabled
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W58
            reason: Lambda function has permission to write CloudWatch Logs via the attached IAM role
          - id: W89
            reason: Lambda function does not need to be deployed inside a VPC
          - id: W92
            reason: Lambda function does not need reserved concurrency
          - id: W11
            reason: CloudWatch does not support resource-level permissions
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/sync_bda_idp_resolver
      Timeout: 300  # 5 minutes for sync operation
      Description: Lambda function to synchronously sync BDA blueprints with IDP classes
      MemorySize: 512
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          CONFIGURATION_TABLE_NAME: !Ref ConfigurationTableName
          STACK_NAME: !Ref StackName
          BDA_PROJECT_ARN: !If
            - HasBDAProjectArn
            - !Ref Pattern1BDAProjectArn
            - !Ref Pattern1BDAProjectArn
      LoggingConfig:
        LogGroup: !Ref SyncBdaIdpResolverFunctionLogGroup
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ConfigurationTableName
        - S3ReadPolicy:
            BucketName: !Ref ConfigurationBucketName
        - Statement:
            # CloudWatch metrics permission
            - Effect: Allow
              Action: cloudwatch:PutMetricData
              Resource: '*'
            # KMS permissions for encryption
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn
            # BDA permissions for blueprint management
            - Effect: Allow
              Action:
                - bedrock:InvokeDataAutomationAsync
                - bedrock:CreateDataAutomationProject
                - bedrock:UpdateDataAutomationProject
                - bedrock:GetDataAutomationProject
                - bedrock:GetDataAutomationStatus
                - bedrock:GetBlueprint
                - bedrock:UpdateBlueprint
                - bedrock:CreateBlueprint
                - bedrock:CreateBlueprintVersion
                - bedrock:ListBlueprints
                - bedrock:DeleteBlueprint
              Resource:
                - !If
                  - HasBDAProjectArn
                  - !Ref Pattern1BDAProjectArn
                  - !Ref Pattern1BDAProjectArn
                - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:${AWS::AccountId}:blueprint/*"
                - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}:aws:blueprint/*"


  ##########################################################################
  # SyncBdaIdpDataSource
  ##########################################################################
  SyncBdaIdpDataSource:
    Type: AWS::AppSync::DataSource
    Condition: IsPattern1Enabled
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: SyncBdaIdpDataSource
      Description: Lambda function to synchronously sync BDA blueprints with IDP classes
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt SyncBdaIdpResolverFunction.Arn


  ##########################################################################
  # SyncBdaIdpResolver
  ##########################################################################
  SyncBdaIdpResolver:
    Type: AWS::AppSync::Resolver
    Condition: IsPattern1Enabled
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt SyncBdaIdpDataSource.Name
      TypeName: Mutation
      FieldName: syncBdaIdp


  ##########################################################################
  # TestResultsResolverFunctionLogGroup
  ##########################################################################
  TestResultsResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays


  ##########################################################################
  # TestResultsResolverFunction
  ##########################################################################
  TestResultsResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    Properties:
      PermissionsBoundary: !If [HasPermissionsBoundary, !Ref PermissionsBoundaryArn, !Ref AWS::NoValue]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/test_results_resolver
      Description: GraphQL resolver for test results queries
      MemorySize: 512
      Timeout: 300
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          TRACKING_TABLE: !Ref TrackingTableName
          BASELINE_BUCKET: !Ref EvaluationBaselineBucketName
          OUTPUT_BUCKET: !Ref OutputBucketName
          TEST_RESULT_CACHE_UPDATE_QUEUE_URL: !Ref TestResultCacheUpdateQueueUrl
          ATHENA_DATABASE: !Ref ReportingDatabaseName
          ATHENA_OUTPUT_LOCATION: !Sub
            - "s3://${Bucket}/athena-results/"
            - Bucket: !If
                - ShouldCreateReportingBucket
                - !Ref ReportingBucketName
                - !Ref ReportingBucketName
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !Ref TestResultCacheUpdateQueueUrl
            BatchSize: 1
      LoggingConfig:
        LogGroup: !Ref TestResultsResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTableName
        - S3ReadPolicy:
            BucketName: !Ref EvaluationBaselineBucketName
        - S3ReadPolicy:
            BucketName: !Ref OutputBucketName
        - S3ReadPolicy:
            BucketName: !Ref ReportingBucketName
        - Statement:
            - Effect: Allow
              Action:
                - s3:PutObject
                - s3:PutObjectAcl
              Resource: !Sub
                - "${BucketArn}/athena-results/*"
                - BucketArn: !If
                    - ShouldCreateReportingBucket
                    - !Sub "arn:${AWS::Partition}:s3:::${ReportingBucketName}"
                    - !Sub "arn:${AWS::Partition}:s3:::${ReportingBucketName}"
        - Statement:
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource: !Sub "arn:${AWS::Partition}:sqs:${AWS::Region}:${AWS::AccountId}:${TestResultCacheUpdateQueueUrl}"
        - Statement:
            - Effect: Allow
              Action:
                - athena:StartQueryExecution
                - athena:GetQueryExecution
                - athena:GetQueryResults
                - athena:StopQueryExecution
              Resource:
                - !Sub "arn:${AWS::Partition}:athena:${AWS::Region}:${AWS::AccountId}:workgroup/primary"
                - !Sub "arn:${AWS::Partition}:athena:${AWS::Region}:${AWS::AccountId}:datacatalog/*"
        - Statement:
            - Effect: Allow
              Action:
                - glue:GetTable
                - glue:GetPartitions
              Resource:
                - !Sub "arn:${AWS::Partition}:glue:${AWS::Region}:${AWS::AccountId}:catalog"
                - !Sub "arn:${AWS::Partition}:glue:${AWS::Region}:${AWS::AccountId}:database/${ReportingDatabaseName}"
                - !Sub "arn:${AWS::Partition}:glue:${AWS::Region}:${AWS::AccountId}:table/${ReportingDatabaseName}/*"
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # TestResultsDataSource
  ##########################################################################
  TestResultsDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: TestResultsDataSource
      Description: Lambda function for test results queries
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt TestResultsResolverFunction.Arn


  ##########################################################################
  # GetTestRunsResolver
  ##########################################################################
  GetTestRunsResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt TestResultsDataSource.Name
      TypeName: Query
      FieldName: getTestRuns


  ##########################################################################
  # CompareTestRunsResolver
  ##########################################################################
  CompareTestRunsResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt TestResultsDataSource.Name
      TypeName: Query
      FieldName: compareTestRuns


  ##########################################################################
  # GetTestRunResolver
  ##########################################################################
  GetTestRunResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt TestResultsDataSource.Name
      TypeName: Query
      FieldName: getTestRun


  ##########################################################################
  # GetTestRunStatusResolver
  ##########################################################################
  GetTestRunStatusResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt TestResultsDataSource.Name
      TypeName: Query
      FieldName: getTestRunStatus


  ##########################################################################
  # TestRunnerFunctionLogGroup
  ##########################################################################
  TestRunnerFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays

  ##########################################################################
  # SQS Queue for test file copying jobs
  ##########################################################################


  ##########################################################################
  # TestRunnerFunction
  ##########################################################################
  TestRunnerFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary: !If [HasPermissionsBoundary, !Ref PermissionsBoundaryArn, !Ref AWS::NoValue]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/test_runner
      Description: Lambda function to run test sets via GraphQL API
      MemorySize: 256
      Timeout: 300
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          INPUT_BUCKET: !Ref InputBucketName
          BASELINE_BUCKET: !If
            - ShouldCreateEvaluationBaselineBucket
            - !Ref EvaluationBaselineBucketName
            - !Ref EvaluationBaselineBucketName
          CONFIG_TABLE: !Ref ConfigurationTableName
          TRACKING_TABLE: !Ref TrackingTableName
          FILE_COPY_QUEUE_URL: !Ref TestFileCopyQueueUrl
      LoggingConfig:
        LogGroup: !Ref TestRunnerFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref ConfigurationTableName
        - S3CrudPolicy:
            BucketName: !Ref InputBucketName
        - S3CrudPolicy:
            BucketName: !If
              - ShouldCreateEvaluationBaselineBucket
              - !Ref EvaluationBaselineBucketName
              - !Ref EvaluationBaselineBucketName
        - SQSSendMessagePolicy:
            QueueName: !Select [5, !Split ["/", !Ref TestFileCopyQueueUrl]]
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # TestRunnerDataSource
  ##########################################################################
  TestRunnerDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: TestRunnerDataSource
      Description: Lambda function for running test sets
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt TestRunnerFunction.Arn


  ##########################################################################
  # TestRunnerResolver
  ##########################################################################
  TestRunnerResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt TestRunnerDataSource.Name
      TypeName: Mutation
      FieldName: startTestRun


  ##########################################################################
  # TestSetResolverFunctionLogGroup
  ##########################################################################
  TestSetResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays


  ##########################################################################
  # TestSetResolverFunction
  ##########################################################################
  TestSetResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
    Properties:
      PermissionsBoundary: !If [HasPermissionsBoundary, !Ref PermissionsBoundaryArn, !Ref AWS::NoValue]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/test_set_resolver
      Description: GraphQL resolver for test set mutations
      MemorySize: 256
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          TRACKING_TABLE: !Ref TrackingTableName
          INPUT_BUCKET: !Ref InputBucketName
          TEST_SET_BUCKET: !Ref TestSetBucketName
          TEST_SET_COPY_QUEUE_URL: !Ref TestSetFileCopyQueueUrl
          BASELINE_BUCKET: !If
            - ShouldCreateEvaluationBaselineBucket
            - !Ref EvaluationBaselineBucketName
            - !Ref EvaluationBaselineBucketName
      LoggingConfig:
        LogGroup: !Ref TestSetResolverFunctionLogGroup
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackingTableName
        - S3ReadPolicy:
            BucketName: !Ref InputBucketName
        - S3ReadPolicy:
            BucketName: !If
              - ShouldCreateEvaluationBaselineBucket
              - !Ref EvaluationBaselineBucketName
              - !Ref EvaluationBaselineBucketName
        - SQSSendMessagePolicy:
            QueueName: !Select [5, !Split ["/", !Ref TestSetFileCopyQueueUrl]]
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # TestSetDataSource
  ##########################################################################
  TestSetDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: TestSetDataSource
      Description: Lambda function for test set mutations
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt TestSetResolverFunction.Arn


  ##########################################################################
  # AddTestSetResolver
  ##########################################################################
  AddTestSetResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt TestSetDataSource.Name
      TypeName: Mutation
      FieldName: addTestSet


  ##########################################################################
  # AddTestSetFromUploadResolver
  ##########################################################################
  AddTestSetFromUploadResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt TestSetDataSource.Name
      TypeName: Mutation
      FieldName: addTestSetFromUpload


  ##########################################################################
  # DeleteTestSetsResolver
  ##########################################################################
  DeleteTestSetsResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt TestSetDataSource.Name
      TypeName: Mutation
      FieldName: deleteTestSets


  ##########################################################################
  # GetTestSetsResolver
  ##########################################################################
  GetTestSetsResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt TestSetDataSource.Name
      TypeName: Query
      FieldName: getTestSets


  ##########################################################################
  # ListBucketFilesResolver
  ##########################################################################
  ListBucketFilesResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt TestSetDataSource.Name
      TypeName: Query
      FieldName: listBucketFiles


  ##########################################################################
  # ValidateTestFileNameResolver
  ##########################################################################
  ValidateTestFileNameResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt TestSetDataSource.Name
      TypeName: Query
      FieldName: validateTestFileName
      

  ##########################################################################
  # UploadResolverFunctionLogGroup
  ##########################################################################
  UploadResolverFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      RetentionInDays: !Ref LogRetentionDays

  # AppSync resolver data source

  ##########################################################################
  # UploadResolverFunction
  ##########################################################################
  UploadResolverFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W12
            reason: "Lambda requires CloudWatch logs permissions"
          - id: W89
            reason: "Function does not require VPC access as it only interacts with AWS services via APIs"
          - id: W92
            reason: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for AppSync resolver function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      PermissionsBoundary:
        !If [
          HasPermissionsBoundary,
          !Ref PermissionsBoundaryArn,
          !Ref AWS::NoValue,
        ]
      Handler: index.handler
      Runtime: python3.12
      CodeUri: ./src/lambda/upload_resolver
      Description: Lambda function to return signed upload URL via GraphQL API
      MemorySize: 512
      Timeout: 60
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
          INPUT_BUCKET: !Ref InputBucketName
      LoggingConfig:
        LogGroup: !Ref UploadResolverFunctionLogGroup
      Policies:
        - S3WritePolicy:
            BucketName: !Ref InputBucketName
        - S3WritePolicy:
            BucketName: !Ref ConfigurationBucketName
        - S3WritePolicy:
            BucketName: !Ref OutputBucketName
        - S3WritePolicy:
            BucketName: !If
              - ShouldCreateEvaluationBaselineBucket
              - !Ref EvaluationBaselineBucketName
              - !Ref EvaluationBaselineBucketName
        - Statement:
            - Effect: Allow
              Action:
                - kms:Encrypt
                - kms:Decrypt
                - kms:ReEncrypt*
                - kms:GenerateDataKey*
                - kms:DescribeKey
              Resource: !Ref CustomerManagedEncryptionKeyArn


  ##########################################################################
  # UploadResolverDataSource
  ##########################################################################
  UploadResolverDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !Ref GraphQLApiId
      Name: UploadResolverDataSource
      Description: Lambda function for generating presigned URLs
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt UploadResolverFunction.Arn

  # AppSync resolver

  ##########################################################################
  # UploadDocumentResolver
  ##########################################################################
  UploadDocumentResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      DataSourceName: !GetAtt UploadResolverDataSource.Name
      TypeName: Mutation
      FieldName: uploadDocument

  ##########################################################################
  # Discovery Upload Resolver
  ##########################################################################


  ##########################################################################
  # UpdateDocumentResolver
  ##########################################################################
  UpdateDocumentResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Mutation
      FieldName: updateDocument
      DataSourceName: !GetAtt TrackingTableDataSource.Name
      RequestMappingTemplate: |-
        #set( $PK = "doc#${ctx.args.input.ObjectKey}" )
        #set( $expNames = {} )
        #set( $expValues = {} )
        #set( $expSet = {} )
        ## Iterate through each argument with values and update expression variables **
        #foreach( $entry in $ctx.args.input.entrySet() )
            ## skip empty values **
            #if( !$util.isNullOrBlank($entry.value)  )
                $util.qr( $expSet.put("#${entry.key}", ":${entry.key}") )
                $util.qr( $expNames.put("#${entry.key}", "${entry.key}") )
                $util.qr( $expValues.put(":${entry.key}", $util.dynamodb.toDynamoDB($entry.value)) )
            #end
        #end
        ## Start building the update expression, starting with attributes we're going to SET **
        #set( $expression = "" )
        #if( !${expSet.isEmpty()} )
            #set( $expression = "SET" )
            #foreach( $entry in $expSet.entrySet() )
                #set( $expression = "${expression} ${entry.key} = ${entry.value}" )
                #if ( $foreach.hasNext )
                    #set( $expression = "${expression}," )
                #end
            #end
        #end
        {
            "version" : "2018-05-29",
            "operation" : "UpdateItem",
            "key" : {
              "PK": $util.dynamodb.toDynamoDBJson($PK),
              "SK": $util.dynamodb.toDynamoDBJson("none"),
            },
            "update" : {
                "expression": "$expression"
                #if( !${expNames.isEmpty()} )
                , "expressionNames": $utils.toJson($expNames)
                #end
                #if( !${expValues.isEmpty()} )
                , "expressionValues": $utils.toJson($expValues)
                #end
            }
        }
      ResponseMappingTemplate: |
        $util.toJson($ctx.result)


  ##########################################################################
  # GetDocumentResolver
  ##########################################################################
  GetDocumentResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Query
      FieldName: getDocument
      DataSourceName: !GetAtt TrackingTableDataSource.Name
      RequestMappingTemplate: |
        #set( $PK = "doc#${context.arguments.ObjectKey}" )
        {
          "version": "2018-05-29",
          "operation": "GetItem",
          "key" : {
            "PK": $util.dynamodb.toDynamoDBJson($PK),
            "SK": $util.dynamodb.toDynamoDBJson("none"),
          }
        }
      ResponseMappingTemplate: |
        $util.toJson($ctx.result)


  ##########################################################################
  # ListDocumentResolver
  ##########################################################################
  ListDocumentResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Query
      FieldName: listDocuments
      DataSourceName: !GetAtt TrackingTableDataSource.Name
      RequestMappingTemplate: |
        {
            "version": "2018-05-29",
            "operation": "Scan",
            "filter": {
                #if($context.arguments.startDateTime && $context.arguments.endDateTime)
                    "expression": "InitialEventTime BETWEEN :startDateTime AND :endDateTime",
                    "expressionValues": {
                        ":startDateTime": { "S": "$context.arguments.startDateTime" },
                        ":endDateTime": { "S": "$context.arguments.endDateTime" }
                    }
                #elseif($context.arguments.startDateTime)
                    "expression": "InitialEventTime >= :startDateTime",
                    "expressionValues": {
                        ":startDateTime": { "S": "$context.arguments.startDateTime" }
                    }
                #elseif($context.arguments.endDateTime)
                    "expression": "InitialEventTime <= :endDateTime",
                    "expressionValues": {
                        ":endDateTime": { "S": "$context.arguments.endDateTime" }
                    }
                #end
            },
            #if($context.prev.result)
                "nextToken": "$context.prev.result.nextToken",
            #end
            "limit": 50,
            "consistentRead": false,
            "select": "ALL_ATTRIBUTES"
        }
      ResponseMappingTemplate: |
        {
            "Documents": $util.toJson($ctx.result.items),
            "nextToken": $util.toJson($ctx.result.nextToken)
        }


  ##########################################################################
  # ListDocumentDateHourResolver
  ##########################################################################
  ListDocumentDateHourResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Query
      FieldName: listDocumentsDateHour
      DataSourceName: !GetAtt TrackingTableDataSource.Name
      RequestMappingTemplate: |
        #set( $shardsInDay = 6 )
        #set( $shardDivider = 24 / $shardsInDay )
        #set( $Integer = 0 )
        #set( $now = $util.time.nowISO8601() )
        #set( $hourNow = $Integer.parseInt($now.substring(11, 13)) )
        #set( $date = $util.defaultIfNullOrBlank($ctx.args.date, $now.substring(0, 10)) )
        #set( $hour = $util.defaultIfNull($ctx.args.hour, $hourNow) )
        #if( $hour < 0 || $hour > 23 )
          $util.error("Invalid hour parameter - value should be between 0 and 23")
        #end
        #set( $hourPad = $date.format("%02d", $hour) )
        #set( $hourShard = $hour / $shardDivider )
        #set( $shardPad = $date.format("%02d", $hourShard) )

        #set( $PK = "list#${date}#s#${shardPad}" )
        #set( $skPrefix = "ts#${date}T${hourPad}" )

        {
          "version" : "2018-05-29",
          "operation" : "Query",
          "query" : {
            "expression": "PK = :PK and begins_with(SK, :prefix)",
            "expressionValues": {
              ":PK": $util.dynamodb.toDynamoDBJson($PK),
              ":prefix": $util.dynamodb.toDynamoDBJson($skPrefix),
            },
          },
        }
      ResponseMappingTemplate: |
        {
            "Documents": $util.toJson($ctx.result.items),
            "nextToken": $util.toJson($ctx.result.nextToken)
        }


  ##########################################################################
  # ListDocumentDateShardResolver
  ##########################################################################
  ListDocumentDateShardResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Query
      FieldName: listDocumentsDateShard
      DataSourceName: !GetAtt TrackingTableDataSource.Name
      RequestMappingTemplate: |
        #set( $shardsInDay = 6 )
        #set( $shardDivider = 24 / $shardsInDay )
        #set( $Integer = 0 )
        #set( $now = $util.time.nowISO8601() )
        #set( $hourNow = $Integer.parseInt($now.substring(11, 13)) )
        #set( $shardNow = $hourNow / $shardDivider )
        #set( $date = $util.defaultIfNullOrBlank($ctx.args.date, $now.substring(0, 10)) )
        #set( $shard = $util.defaultIfNull($ctx.args.shard, $shardNow) )
        #if( $shard >= $shardsInDay )
          $util.error("Invalid shard parameter value - must positive and less than ${shardsInDay}")
        #end
        #set( $hourShard = $hour / $shardDivider )
        #set( $shardPad = $date.format("%02d", $shard) )

        #set( $PK = "list#${date}#s#${shardPad}" )

        {
          "version" : "2018-05-29",
          "operation" : "Query",
          "query" : {
            "expression": "PK = :PK",
            "expressionValues": {
              ":PK": $util.dynamodb.toDynamoDBJson($PK),
            }
          }
        }
      ResponseMappingTemplate: |
        {
            "Documents": $util.toJson($ctx.result.items),
            "nextToken": $util.toJson($ctx.result.nextToken)
        }


  ##########################################################################
  # GetAgentJobStatusResolver
  ##########################################################################
  GetAgentJobStatusResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Query
      FieldName: getAgentJobStatus
      DataSourceName: !GetAtt AgentTableDataSource.Name
      RequestMappingTemplate: |
        #set($userId = $context.identity.username)
        #if(!$userId)
          #set($userId = $context.identity.sub)
        #end
        #if(!$userId)
          #set($userId = "anonymous")
        #end
        {
          "version": "2018-05-29",
          "operation": "GetItem",
          "key": {
            "PK": $util.dynamodb.toDynamoDBJson("agent#${userId}"),
            "SK": $util.dynamodb.toDynamoDBJson($ctx.args.jobId)
          }
        }
      ResponseMappingTemplate: |
        #if(!$ctx.result)
          null
        #else
          {
            "jobId": $util.toJson($ctx.result.SK),
            "status": $util.toJson($ctx.result.status),
            "query": $util.toJson($ctx.result.query),
            "agentIds": $util.toJson($ctx.result.agentIds),
            "createdAt": $util.toJson($ctx.result.createdAt),
            "completedAt": $util.toJson($ctx.result.completedAt),
            "result": $util.toJson($ctx.result.result),
            "error": $util.toJson($ctx.result.error),
            "agent_messages": $util.toJson($ctx.result.agent_messages)
          }
        #end


  ##########################################################################
  # ListAgentJobsResolver
  ##########################################################################
  ListAgentJobsResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Query
      FieldName: listAgentJobs
      DataSourceName: !GetAtt AgentTableDataSource.Name
      RequestMappingTemplate: |
        #set($userId = $context.identity.username)
        #if(!$userId)
          #set($userId = $context.identity.sub)
        #end
        #if(!$userId)
          #set($userId = "anonymous")
        #end
        {
          "version": "2018-05-29",
          "operation": "Query",
          "query": {
            "expression": "PK = :pk",
            "expressionValues": {
              ":pk": $util.dynamodb.toDynamoDBJson("agent#${userId}")
            }
          },
          #if($ctx.args.limit)
            "limit": $ctx.args.limit,
          #end
          #if($ctx.args.nextToken)
            "nextToken": "$ctx.args.nextToken",
          #end
          "scanIndexForward": false
        }
      ResponseMappingTemplate: |
        {
          "items": [
            #foreach($item in $ctx.result.items)
              {
                "jobId": $util.toJson($item.SK),
                "status": $util.toJson($item.status),
                "query": $util.toJson($item.query),
                "agentIds": $util.toJson($item.agentIds),
                "createdAt": $util.toJson($item.createdAt),
                "completedAt": $util.toJson($item.completedAt),
                "result": $util.toJson($item.result),
                "error": $util.toJson($item.error)
              }#if($foreach.hasNext),#end
            #end
          ],
          "nextToken": $util.toJson($ctx.result.nextToken)
        }


  ##########################################################################
  # UpdateAgentJobStatusResolver
  ##########################################################################
  UpdateAgentJobStatusResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Mutation
      FieldName: updateAgentJobStatus
      DataSourceName: !GetAtt AgentTableDataSource.Name
      RequestMappingTemplate: |-
        #set($userId = $ctx.args.userId)
        #set($expNames = {})
        #set($expValues = {})

        ## Set status (required)
        $util.qr($expNames.put("#status", "status"))
        $util.qr($expValues.put(":status", $util.dynamodb.toDynamoDB($ctx.args.status)))
        #set($updateExpression = "SET #status = :status")

        ## Set result (optional)
        #if($ctx.args.result)
          $util.qr($expNames.put("#result", "result"))
          $util.qr($expValues.put(":result", $util.dynamodb.toDynamoDB($ctx.args.result)))
          #set($updateExpression = "${updateExpression}, #result = :result")
        #end

        ## Set completedAt to current timestamp when status is COMPLETED or FAILED
        #if($ctx.args.status == "COMPLETED" || $ctx.args.status == "FAILED")
          $util.qr($expNames.put("#completedAt", "completedAt"))
          $util.qr($expValues.put(":completedAt", $util.dynamodb.toDynamoDB($util.time.nowISO8601())))
          #set($updateExpression = "${updateExpression}, #completedAt = :completedAt")
        #end

        {
          "version": "2018-05-29",
          "operation": "UpdateItem",
          "key": {
            "PK": $util.dynamodb.toDynamoDBJson("agent#${userId}"),
            "SK": $util.dynamodb.toDynamoDBJson($ctx.args.jobId)
          },
          "update": {
            "expression": "$updateExpression",
            "expressionNames": $utils.toJson($expNames),
            "expressionValues": $utils.toJson($expValues)
          }
        }
      ResponseMappingTemplate: |-
        #if($ctx.error)
          $util.error($ctx.error.message, $ctx.error.type)
        #end

        ## Return false if no item was updated (item not found)
        #if(!$ctx.result)
          false
        #else
          true
        #end


  ##########################################################################
  # DeleteAgentJobResolver
  ##########################################################################
  DeleteAgentJobResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: GraphQLSchema
    Properties:
      ApiId: !Ref GraphQLApiId
      TypeName: Mutation
      FieldName: deleteAgentJob
      DataSourceName: !GetAtt AgentTableDataSource.Name
      RequestMappingTemplate: |-
        #set($userId = $context.identity.username)
        #if(!$userId)
          #set($userId = $context.identity.sub)
        #end
        #if(!$userId)
          #set($userId = "anonymous")
        #end
        {
          "version": "2018-05-29",
          "operation": "DeleteItem",
          "key": {
            "PK": $util.dynamodb.toDynamoDBJson("agent#${userId}"),
            "SK": $util.dynamodb.toDynamoDBJson($ctx.args.jobId)
          }
        }
      ResponseMappingTemplate: |-
        #if($ctx.error)
          $util.error($ctx.error.message, $ctx.error.type)
        #else
          true
        #end



Outputs:
  AppSyncServiceRoleArn:
    Description: ARN of the AppSync service role
    Value: !GetAtt AppSyncServiceRole.Arn